<!DOCTYPE html>
<html lang="it" style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Safe Place - Prototipo GDR (V14 - Final)</title>
    <style>
        /* --- CSS Completo e Verificato --- */
        :root {
            --bg-color: #000000; --fg-color: #00FF00; --fg-dim-color: #009900;
            --border-color: #00FF00; --border-dim-color: #005500;
            --highlight-bg: #00FF00; --highlight-fg: #000000;
            --accent-color: #FFFF00; --danger-color: #FF4444;
            --overlay-bg: rgba(0, 10, 0, 0.97);
            --plains-color: #00BB00; --forest-color: #008800; --mountain-color: #339933;
            --water-color: #008888; --ruin-color: #55AA55; --special-color: #AAAA00;
            --end-color: var(--accent-color);
        }
        html { height: 100%; }
        body { background-color: var(--bg-color); color: var(--fg-color); font-family: 'Courier New', Courier, monospace; font-size: 16px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; height: 100%; box-sizing: border-box; overflow: hidden; }
        /* Splash, End Screen */
        #splash-screen, #end-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--fg-color); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 100; padding: 20px; box-sizing: border-box; }
        #end-screen { z-index: 99; display: none; } /* Nascosto */
        #end-message { white-space: pre-wrap; max-height: 80%; overflow-y: auto; margin-bottom: 20px; font-size: 1.1em; line-height: 1.4; text-align: left; /* Allinea testo finale a sinistra */ padding: 0 10%; } /* Aggiunge padding orizzontale */
        #end-screen h2 { color: var(--accent-color); margin-bottom: 30px; }
        #end-screen button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 10px 20px; font-family: inherit; font-size: 1.1em; cursor: pointer; margin-top: 20px;}
        #splash-screen h1 { font-size: 2.5em; margin-bottom: 15px; text-shadow: 0 0 5px var(--fg-color); }
        #splash-screen p.subtitle { font-size: 1.1em; margin-bottom: 20px; font-style: italic; opacity: 0.9; }
        #splash-screen p.attribution { font-size: 0.9em; margin-top: 20px; margin-bottom: 30px; opacity: 0.8; }
        @keyframes buttonBlink { 0%, 100% { background-color: #111; color: var(--fg-color); border-color: var(--border-color); box-shadow: 0 0 8px var(--fg-color); } 50% { background-color: var(--highlight-bg); color: var(--highlight-fg); border-color: var(--border-color); box-shadow: 0 0 15px var(--fg-color); } }
        #splash-screen button { background-color: #111; color: var(--fg-color); border: 2px solid var(--border-color); padding: 10px 20px; font-family: inherit; font-size: 1.2em; cursor: pointer; box-shadow: 0 0 8px var(--fg-color); animation: buttonBlink 1.3s step-end infinite; }
        /* --- Aggiunta Stile Intro Screen --- */
        #intro-screen { display: none; /* Nascosto inizialmente */ position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--fg-color); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 98; padding: 30px; box-sizing: border-box; }
        #intro-screen h2 { color: var(--accent-color); margin-bottom: 25px; }
        #intro-text { white-space: pre-wrap; max-height: 70%; overflow-y: auto; margin-bottom: 25px; font-size: 1.0em; line-height: 1.5; text-align: left; max-width: 800px; }
        #intro-screen button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 10px 20px; font-family: inherit; font-size: 1.1em; cursor: pointer; margin-top: 15px; }
        /* --- Fine Stile Intro Screen --- */
        /* Game Container e Sezioni con TAG SEMANTICI */
        main#game-container { display: none; flex-direction: row; border: 2px solid var(--border-color); padding: 10px; box-sizing: border-box; position: relative; width: 100%; height: 100%; max-width: 1000px; max-height: 700px; background-color: var(--bg-color); overflow: hidden; }
        section#map-area { flex: 3; border-right: 1px dashed var(--border-color); padding-right: 10px; margin-right: 10px; display: flex; flex-direction: column; overflow: hidden; }
        #map-display { font-family: 'Courier New', Courier, monospace; white-space: pre; font-size: 18px; line-height: 1.1; margin-bottom: 10px; flex-grow: 1; overflow: auto; background-color: #050505; border: 1px solid var(--border-dim-color); padding: 5px; box-sizing: border-box; }
        /* Stili Colore Mappa */
        .tile-plains { color: var(--plains-color); } .tile-forest { color: var(--forest-color); } .tile-mountain { color: var(--mountain-color); } .tile-river { color: var(--water-color); } .tile-city, .tile-village { color: var(--ruin-color); } .tile-rest-stop, .tile-start { color: var(--special-color); } .tile-end { color: var(--end-color); font-weight: bold; }
        .visited { opacity: 0.6 !important; }
        .player-marker { animation: blink 1s step-end infinite; } @keyframes blink {0%,100%{background-color:var(--highlight-bg);color:var(--highlight-fg);}50%{background-color:transparent;color:var(--fg-color);}}
        #controls { text-align: center; margin-top: 5px; flex-shrink: 0; }
        #controls button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 5px 10px; margin: 2px; font-family: inherit; font-size: 14px; cursor: pointer; }
        #controls button:disabled { color: var(--border-dim-color); border-color: var(--border-dim-color); cursor: not-allowed; }
        section#status-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 220px; }
        #character-stats, #map-legend { margin-bottom: 15px; flex-shrink: 0; }
        #character-stats h3, #map-legend h3, #message-log h3 { margin-top: 0; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); padding-bottom: 3px; flex-shrink: 0; font-size: 1em; }
        #character-stats ul, #map-legend ul { list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        #character-stats li, #map-legend li { margin-bottom: 2px; white-space: nowrap; }
        #stat-food, #stat-water { font-weight: bold; } .low-resource { color: var(--danger-color); }
        #map-legend .legend-symbol { display: inline-block; width: 1.5em; text-align: center; font-weight: bold; }
        #message-log { border-top: 1px dashed var(--border-color); padding-top: 5px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; background-color: #050505; border: 1px solid var(--border-dim-color); padding: 5px; margin-top: 5px; min-height: 100px; }
        #messages { list-style: none; padding: 0; margin: 0; } #messages li { font-size: 0.9em; margin-bottom: 4px; word-break: break-word; } .log-warning { color: var(--danger-color); font-weight: bold;}
        /* Event Overlay */
         #event-overlay { display: none; position: absolute; top: 5%; left: 5%; width: 90%; height: 85%; background-color: var(--overlay-bg); border: 3px solid var(--border-color); color: var(--fg-color); z-index: 50; padding: 15px; box-sizing: border-box; font-size: 1em; overflow-y: auto; text-align: center; }
         #event-overlay h4 { margin-top: 0; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 15px; font-size: 1.2em; }
         #event-content { margin-bottom: 15px; text-align: left; white-space: pre-wrap; font-size: 0.95em; }
         .danger-text { color: var(--danger-color); font-weight: bold; }
         .event-choice { margin-top: 10px; text-align: left; cursor: default; }
         .event-choice-key { font-weight: bold; color: var(--accent-color); margin-right: 5px;}
         #event-overlay button.continue-button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 8px 15px; font-family: inherit; font-size: 0.9em; cursor: pointer; margin-top: 10px; }
        .hidden { display: none !important; }
        /* Media Query Mobile */
        @media (max-width: 700px) { body{align-items:stretch;} main#game-container{flex-direction:column; max-width:100%; max-height:none; height:100%; padding:5px; border:none;} section#map-area{flex:1 1 55%; border-right:none; border-bottom:1px dashed var(--border-color); padding-right:0; margin-right:0; margin-bottom:10px;} #map-display{font-size:14px; line-height:1.0;} #controls{order:1; margin-bottom:10px;} section#status-area{flex:1 1 45%; min-width:unset; width:100%; order:2;} #map-legend{display:none;} #message-log{font-size:0.85em;} #event-overlay{width:95%; left:2.5%; height:90%; top:2.5%; font-size:0.9em;} #splash-screen h1{font-size:2em;} #splash-screen p.subtitle{font-size:1em;} /* Rimosso stile intro */ }
    </style>
</head>
<body style="height: 100%;">

    <div id="splash-screen"><h1>THE SAFE PLACE</h1><p class="subtitle">Un sussurro di speranza tra le rovine...</p><p class="attribution">un'idea di Simone Pizzi</p><button onclick="startGame()">Inizia il Viaggio</button></div>
    <!-- --- Aggiunta Intro Screen --- -->
    <div id="intro-screen">
        <h2>Prologo</h2>
        <div id="intro-text">
Il mondo come lo conoscevi non esiste più. Le città sono tombe silenziose, le strade sentieri interrotti verso il nulla.
Sei l'Ultimo, o almeno così ti chiamano i pochi disperati che incroci. La tua esistenza è una lotta costante per le risorse più basilari: cibo, acqua, un riparo dal vento gelido che spira tra le rovine.

Ma un giorno, tra i rottami di un vecchio terminale, hai trovato un messaggio frammentato. Parlava di un "Safe Place", un rifugio leggendario dove la civiltà resiste ancora, nascosto da qualche parte in questo mondo devastato.
Senza altra speranza a cui aggrapparti, hai deciso di intraprendere il viaggio.

Il cammino sarà lungo e pericoloso. Dovrai attraversare pianure desolate spazzate dal vento, foreste oscure dove si annidano creature mutate, montagne impervie che graffiano il cielo e le rovine infestate di città cadute.
Le tue scorte sono limitate. La fame e la sete saranno compagne costanti. Predoni senza scrupoli e bestie selvagge potrebbero sbarrarti la strada ad ogni passo.

Riuscirai a gestire le tue risorse, a superare gli ostacoli e a trovare la tua destinazione incerta?
Il tuo viaggio inizia ora. Buona fortuna, Ultimo.
        </div>
        <button onclick="proceedToGame()">Inizia</button>
    </div>
    <!-- --- Fine Intro Screen --- -->
    <!-- Rimosso Intro Overlay -->
    <div id="end-screen"> <h2 id="end-title">...</h2><div id="end-message">...</div><button onclick="window.location.reload()">Ricomincia il Viaggio</button> </div>

    <!-- Contenuto Principale -->
    <main id="game-container">
        <section id="map-area">
            <pre id="map-display">Attendere...</pre>
            <div id="controls"><button onclick="movePlayer(0, -1)" id="btn-up">Nord</button><br/><button onclick="movePlayer(-1, 0)" id="btn-left">Ovest</button><button onclick="movePlayer(1, 0)" id="btn-right">Est</button><br/><button onclick="movePlayer(0, 1)" id="btn-down">Sud</button></div>
        </section>
        <section id="status-area">
             <div id="character-stats"><h3>ULTIMO</h3><ul id="stats-list"><li>HP:<span id="stat-hp">--</span>/<span id="stat-maxhp">--</span></li><li>Vigore:<span id="stat-vig">--</span></li><li>Potenza:<span id="stat-pot">--</span></li><li>Agilita':<span id="stat-agi">--</span></li><li>Tracce:<span id="stat-tra">--</span></li><li>Influenza:<span id="stat-inf">--</span></li><li>Presagio:<span id="stat-pre">--</span></li><li>Adattamento:<span id="stat-ada">--</span></li><li>Acquisita:<span id="stat-acq">--</span></li><li>Cibo:<span id="stat-food">--</span></li><li>Acqua:<span id="stat-water">--</span></li><li>Posizione:(<span id="pos-x">--</span>,<span id="pos-y">--</span>)</li><li>Terreno:<span id="tile-type">--</span></li></ul></div>
             <div id="map-legend"><h3>LEGENDA</h3><ul id="legend-list"></ul></div>
             <div id="message-log"><ul id="messages"></ul><h3>LOG EVENTI</h3></div>
        </section>
        <div id="event-overlay"><h4 id="event-title">...</h4><div id="event-content">...</div><button onclick="hideEventScreen()" class="continue-button">Continua...</button></div>
    </main>

    <!-- Lo script andrà nel prossimo blocco -->
    <script>
        // Il codice JavaScript verrà fornito nel prossimo messaggio
// --- CONFIGURAZIONE E COSTANTI ---
const MAP_WIDTH=50; const MAP_HEIGHT=30; const MAX_MESSAGES=30;
const CONSUMPTION_RATE=10; const STARTING_FOOD=7; const STARTING_WATER=7; // Modificato da 6 a 7
const TILE_SYMBOLS = { PLAINS:'.', MOUNTAIN:'M', RIVER:'~', FOREST:'F', VILLAGE:'V', CITY:'C', REST_STOP:'R', START:'S', END:'E', PLAYER:'@' };
const TILE_DESC = { '.':'Pianura desolata', 'M':'Montagne cicatrizzate', '~':'Fiume lento', 'F':'Foresta opprimente', 'V':'Accampamento isolato', 'C':'Rovine di città', 'R':'Rifugio improvvisato', 'S':"Punto d'inizio", 'E':'Destinazione incerta', '@':'Ultimo (Tu)' }; // Corretto apice in Punto d'inizio

// --- Testi Variabili (Ampliati e Aggiunti) ---
// Flavor Texts Ambientali
const flavorTextsPlains = ["Il vento solleva polvere.", "Un silenzio innaturale.", "Ossa sbiancate dal sole.", "Una carcassa di animale non identificabile giace lontana.", "Il cielo è vasto e indifferente.", "Piccoli arbusti secchi si aggrappano alla vita."];
const flavorTextsForest = ["Rami secchi scricchiolano sotto i piedi.", "Un odore pungente di decomposizione nell'aria.", "Il silenzio è rotto solo dal tuo respiro.", "Intravedi un movimento fugace tra gli alberi... o è solo la tua immaginazione?", "Strani simboli sono incisi sulla corteccia di un albero antico.", "La luce filtra a fatica tra le fitte chiome."];
const flavorTextsMountain = ["Un'eco lontana risuona tra le vette.", "Il sentiero è ripido e traditore.", "Un'aquila solitaria volteggia alta nel cielo.", "Senti il rumore di piccole pietre che rotolano in basso.", "La carcassa congelata di uno scalatore sfortunato.", "Il vento fischia tra le rocce aguzze."];
const flavorTextsRiver = ["Detriti e rifiuti galleggiano lenti sull'acqua torbida.", "La riva fangosa rende difficile camminare.", "Un pesce morto galleggia a pancia in su.", "Il suono dell'acqua che scorre è quasi ipnotico.", "Resti di un vecchio ponte crollato."];
const flavorTextsCity = ["Il vento geme tra gli scheletri dei grattacieli.", "Un vecchio manifesto strappato sventola da un muro.", "Carcasse arrugginite di automobili bloccano la strada.", "Un silenzio spettrale avvolge tutto.", "Resti di una bambola di porcellana, con un occhio mancante, tra le macerie.", "Un monitor rotto mostra ancora un'immagine statica."];
const flavorTextsVillage = ["Tende strappate sbattono al vento.", "Un fuoco da campo spento da tempo.", "Oggetti personali sparsi qua e là, abbandonati in fretta.", "Nessun segno di vita recente.", "Un silenzio pesante grava sull'accampamento."];
const flavorTextsRestStop = ["Un riparo precario fatto di lamiere e teli.", "Qualcuno ha lasciato segni qui, ma se n'è andato.", "Puzza di vecchio fumo e umidità.", "Sembra relativamente sicuro, per ora."];

// Lore Fragments (Ampliato)
const loreFragments = [
    "Pagina strappata di diario: '... giorno 47. Le scorte sono finite. Ho sentito di un posto sicuro a est, oltre le montagne spezzate. È la mia ultima speranza...'",
    "Pezzo di metallo inciso: 'Progetto Chimera - Proprietà della Volta 7'",
    "Ologramma tremolante da un dispositivo rotto: '...protocollo di contenimento fallito. Evacuare immediatamente...'",
    "Scheda dati danneggiata: '...mutazione instabile... aggressività elevata... eliminare a vista...'",
    "Scarpa da bambino logora accanto a una piccola croce fatta di rametti.",
    "Graffito su un muro: 'Non fidatevi dell'acqua che brilla.'",
    "Registrazione audio disturbata: '...stanno arrivando... non riesco a fermarli... dite a mia figlia che... *statica*'",
    "Mappa disegnata a mano su un pezzo di pelle: Indica un percorso verso un luogo chiamato \'L\'Oasi\', ma è strappata a metà.", // Corretto escaping apici
    "Messaggio inciso su una capsula di proiettile: 'Per Mamma.'",
    "Libro bruciacchiato con una sola pagina leggibile: '...e così gli Antichi Dei dormirono, lasciando il mondo al silenzio...'"
];

// Testi Eventi (Ampliati e Nuovi)
const descrizioniPredoni = ["Ombre si muovono ai margini della tua vista.", "Figure emergono dalla polvere.", "Un fischio acuto rompe il silenzio.", "Un gruppo malmesso ti circonda.", "Hanno occhi affamati e armi improvvisate."];
const vociPredoni = ["'Fermi lì, bello!'", "'Cosa abbiamo qui? Carne fresca!'", "'Non fare movimenti bruschi.'", "'Svuota le tasche, piano piano.'", "'Il pedaggio per passare di qui.'"];
const esitiFugaPredoniOk = ["Scompari nell'ombra prima che possano reagire.", "Li distrai con un lancio di pietre e scappi.", "Trovi una via di fuga inaspettata tra le rovine.", "La tua agilità ti permette di seminarli."];
const esitiFugaPredoniKo = ["Inciampi e cadi, sei alla loro mercé!", "Esiti un attimo di troppo e ti bloccano.", "La strada è senza uscita!", "Sono più veloci di te."];
const esitiLottaPredoniOk = ["Respingi il loro attacco con ferocia.", "Dopo un breve scontro, decidono che non ne vale la pena e si ritirano.", "Riesci a tenerli a bada, ma sono ancora lì.", "Ne metti uno fuori combattimento e gli altri esitano."];
const esitiLottaPredoniKo = ["Vieni picchiato e lasciato a terra dolorante.", "Ti derubano di quasi tutto.", "La tua resistenza è inutile, ti sopraffanno.", "Una lama ti ferisce gravemente."];
const esitiParlaPredoniOk = ["Sorprendentemente, le tue parole li convincono a lasciarti andare.", "Forse vedono qualcosa in te, o sono solo stanchi. Ti fanno cenno di passare.", "Ti squadrano, poi uno fa un cenno. 'Vattene, prima che cambiamo idea.'"];
const esitiParlaPredoniKo = ["'Belle parole, ma la pancia è vuota!' Ti attaccano.", "Ridono delle tue suppliche e si preparano a prendersi ciò che vogliono.", "Le tue parole non hanno effetto sul loro cinismo."];

const descrizioniAnimali = ["Un branco di cani selvatici dagli occhi iniettati di sangue.", "Un grosso cinghiale mutato con zanne ricurve.", "Uno sciame di ratti giganti emerge da una crepa.", "Una creatura simile a un lupo, ma con troppe zampe.", "Un volatile dall'aspetto preistorico ti osserva da un tetto."];
const esitiEvitaAnimaleOk = ["Riesci a sgattaiolare via senza farti notare.", "Passi con cautela e l'animale non ti degna di uno sguardo.", "Ti nascondi finché la minaccia non è passata.", "Sfrutti il terreno per aggirare la creatura."];
const esitiEvitaAnimaleKo = ["Sei troppo lento! L'animale ti ha visto.", "Sottovaluti la sua percezione e ti individua.", "Un passo falso rivela la tua posizione!"];
const esitiSpaventaAnimaleOk = ["Un urlo improvviso e un gesto minaccioso lo fanno indietreggiare.", "Una pietra ben lanciata lo convince a cercare prede più facili.", "Il tuo sguardo deciso lo intimorisce e si allontana.", "Batti le mani forte e la creatura fugge spaventata."];
const esitiSpaventaAnimaleKo = ["La bestia si infuria ancora di più!", "Non sembra minimamente intimorito dalla tua presenza.", "Il tuo tentativo lo rende solo più aggressivo."];
const esitiAttaccoAnimaleOk = ["Con un colpo ben assestato, respingi la creatura.", "Riesci a ferirlo abbastanza da farlo fuggire.", "Lo tieni a bada, guadagnando tempo per allontanarti."];
const esitiAttaccoAnimaleKo = ["Le sue zanne affondano nella tua carne.", "Vieni morso e sbattuto a terra.", "La sua furia ti travolge.", "Ti artiglia dolorosamente."];

const descrizioniTracce = ["Noti delle impronte insolite sul terreno.", "Qualcosa ha lasciato segni evidenti del suo passaggio.", "Ci sono tracce di sangue fresco sulla polvere.", "Impronte di stivali pesanti si dirigono verso..."];
const esitiSeguiTracceOkLoot = ["Le tracce ti portano a delle scorte nascoste!", "Seguendo le tracce trovi un piccolo nascondiglio con provviste.", "Chi ha lasciato queste tracce ha perso qualcosa per strada..."];
const esitiSeguiTracceOkLore = ["Le tracce ti conducono a un messaggio criptico inciso su un muro.", "Trovi un diario abbandonato vicino alle impronte.", "Segui le tracce fino ai resti di un piccolo accampamento con alcuni indizi."];
const esitiSeguiTracceOkPredoni = ["Le tracce ti portano dritto in un'imboscata!", "Stavi seguendo dei predoni... e ora ti hanno visto!", "Cadi nella trappola che avevano preparato."];
const esitiSeguiTracceOkNulla = ["Segui le tracce per un po', ma si perdono nel nulla.", "Le impronte finiscono bruscamente, come svanite.", "Il vento ha cancellato le tracce più avanti."];
const esitiSeguiTracceKo = ["Non riesci a seguire le tracce, si confondono.", "Perdi il sentiero e ti ritrovi fuori strada.", "Ti concentri troppo sulle tracce e non noti un pericolo imminente!"];

const descrizioniVillaggioOstile = ["Dalle tende emergono figure guardinghe con armi in pugno.", "Ti osservano in silenzio, con sospetto evidente.", "Un uomo con una cicatrice sul volto ti fa cenno di fermarti.", "Non sembrano per niente amichevoli."];
const esitiVillaggioOstileAllontanati = ["Ti allontani lentamente, senza dare le spalle. Non ti seguono.", "Fai dietrofront con cautela. Meglio non disturbare.", "Capiscono che non vuoi guai e ti lasciano andare."];
const esitiVillaggioOstileNegoziaOk = ["Dopo una tesa conversazione, ti permettono di passare, ma ti avvertono di non fermarti.", "Riesci a convincerli che sei solo di passaggio e non una minaccia.", "Ti scambiano qualche parola diffidente, poi ti ignorano."];
const esitiVillaggioOstileNegoziaKo = ["I tuoi tentativi di diplomazia falliscono. Ti intimano di andartene con minacce.", "'Non vogliamo estranei qui! Vattene o saranno guai!'", "Ti lanciano contro qualcosa per farti capire che non sei il benvenuto."];

const descrizioniPericoloAmbientaleAgilita = ["Il terreno cede sotto i tuoi piedi!", "Una vecchia trappola a scatto è nascosta tra le foglie!", "Sfiori un filo quasi invisibile...", "Una lastra di pavimento instabile si inclina pericolosamente."];
const descrizioniPericoloAmbientalePresagio = ["Detriti cadono dall'alto!", "Senti uno scricchiolio sinistro da una struttura pericolante sopra di te.", "Un forte odore di gas ti avverte di una perdita nelle vicinanze.", "Hai la strana sensazione di essere osservato... e poi una freccia scocca da un muro!"];
const esitiPericoloAmbientaleEvitato = ["Riesci a evitare il peggio grazie ai tuoi riflessi pronti!", "Il tuo istinto ti salva all'ultimo secondo!", "Balzi indietro appena in tempo!", "Ti fermi giusto un attimo prima di finire nella trappola."];
const esitiPericoloAmbientaleColpito = ["Non sei abbastanza veloce! Vieni colpito.", "La trappola scatta, ferendoti.", "Vieni travolto dai detriti.", "Una fitta di dolore ti attraversa la gamba."];

// Nuovo: Dilemma Morale
const descrizioniDilemmaMorale = ["Senti delle grida soffocate provenire da un edificio vicino.", "Vedi del fumo alzarsi da dietro una collina, accompagnato da rumori di lotta.", "Una figura corre verso di te, inseguita da altri.", "Trovi una cassa chiusa con uno strano simbolo, sembra importante..."];
const esitiDilemmaMoraleIndagaOkPositivo = ["Intervieni e riesci a salvare un innocente dai suoi aggressori. Ti ringrazia offrendoti delle provviste.", "Segui il fumo e trovi i resti di uno scontro. Trovi del loot utile tra i caduti.", "Aiuti la figura inseguita a nascondersi. Era un mercante che ti ricompensa."];
const esitiDilemmaMoraleIndagaOkNegativo = ["Arrivi troppo tardi. Le grida sono cessate. Trovi solo morte.", "Era una trappola! I predoni ti stavano aspettando.", "L'inseguito era un ladro, e i suoi inseguitori ora se la prendono con te."];
const esitiDilemmaMoraleIndagaKo = ["Cerchi di intervenire ma sottovaluti la situazione e vieni ferito.", "Non riesci a trovare la fonte delle grida in tempo.", "Il tuo tentativo di aiuto peggiora solo le cose."];
const esitiDilemmaMoraleIgnora = ["Decidi che non sono affari tuoi e prosegui.", "La sopravvivenza viene prima di tutto. Tiri dritto.", "Volti le spalle al pericolo, un peso sulla coscienza."];

// Nuovo: Scelta Rifugio
const descrizioniRifugioStrano = ["Mentre ti riposi, noti una sezione del muro che sembra leggermente diversa.", "C'è un piccolo contenitore metallico nascosto sotto un telo logoro.", "Un simbolo familiare è inciso rozzamente sul pavimento in un angolo."];
const esitiRifugioIspezionaOkLoot = ["Rimuovendo la sezione del muro trovi un piccolo vano con del cibo extra!", "Il contenitore contiene delle munizioni utili!", "Sotto il simbolo trovi una mappa parziale o delle note."];
const esitiRifugioIspezionaOkLore = ["Il simbolo è collegato a una fazione di cui hai sentito parlare...", "Trovi un messaggio lasciato da un precedente occupante.", "Dietro il muro c'è un vecchio terminale, forse riparabile..."];
const esitiRifugioIspezionaKoTrappola = ["Era una trappola! Una piccola carica esplode ferendoti.", "Il contenitore era protetto da un meccanismo che scatta.", "Mentre ispezioni, qualcosa cade dall'alto colpendoti."];
const esitiRifugioIspezionaKoNulla = ["È solo una strana macchia sul muro.", "Il contenitore è vuoto e arrugginito.", "Il simbolo non sembra significare nulla."];
const esitiRifugioLasciaPerdere = ["Meglio non rischiare. Ti concentri sul riposo.", "La curiosità è un lusso che non puoi permetterti.", "Ignori il dettaglio e ti prepari a ripartire."];


// --- Variabili di Stato ---
let player = {}; let map = []; let messages = []; let gameActive = false; let eventScreenActive = false; let currentEventChoices = []; let currentEventContext = null;

// --- Riferimenti DOM (Definiti subito) ---
const splashScreen=document.getElementById('splash-screen');
const gameContainer=document.getElementById('game-container');
const endScreen=document.getElementById('end-screen');
const endTitle=document.getElementById('end-title');
const endMessage=document.getElementById('end-message');
const mapDisplay=document.getElementById('map-display');
const introScreen=document.getElementById('intro-screen');
const statsList=document.getElementById('stats-list');
const statHp=document.getElementById('stat-hp'); const statMaxHp=document.getElementById('stat-maxhp');
const statVig=document.getElementById('stat-vig'); const statPot=document.getElementById('stat-pot');
const statAgi=document.getElementById('stat-agi'); const statTra=document.getElementById('stat-tra');
const statInf=document.getElementById('stat-inf'); const statPre=document.getElementById('stat-pre');
const statAda=document.getElementById('stat-ada'); const statAcq=document.getElementById('stat-acq');
const statFood=document.getElementById('stat-food'); const statWater=document.getElementById('stat-water');
const posX=document.getElementById('pos-x'); const posY=document.getElementById('pos-y');
const tileType=document.getElementById('tile-type');
const messagesList=document.getElementById('messages');
const moveButtons=document.querySelectorAll('#controls button'); // Seleziona solo i bottoni di movimento
const eventOverlay=document.getElementById('event-overlay');
const eventTitle=document.getElementById('event-title');
const eventContent=document.getElementById('event-content');
const legendList=document.getElementById('legend-list');
const continueButton=eventOverlay.querySelector('.continue-button');

// --- FUNZIONI UTILITY ---
function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function getRandomText(arr) { if (!arr || arr.length === 0) return ""; return arr[getRandomInt(0, arr.length - 1)]; }
function addMessage(msg, type = 'info', emphasize = false) { if(typeof msg !== 'string') msg = String(msg); const maxLogMsgLength = 70; let displayMsg = msg.length > maxLogMsgLength ? msg.substring(0, maxLogMsgLength) + '...' : msg; messages.unshift(`${emphasize ? '<span class="log-warning">' : ''}> ${displayMsg}${emphasize ? '</span>' : ''}`); if (messages.length > MAX_MESSAGES) { messages.pop(); } renderMessages(); }

// --- FUNZIONI DI GIOCO ---

// startGame - Mostra l'introduzione
function startGame() {
    console.log("[startGame] Showing Intro");
    splashScreen.style.display = 'none';
    introScreen.style.display = 'flex'; // Mostra intro invece del gioco
    gameContainer.style.display = 'none';
    endScreen.style.display = 'none';
}

// proceedToGame - Inizializza e avvia il gioco dopo l'intro
function proceedToGame() {
    console.log("[proceedToGame] Starting Game Logic");
    introScreen.style.display = 'none'; // Nasconde intro
    gameContainer.style.display = 'flex'; // Mostra gioco

    messages = [];
    player = {};
    map = [];
    gameActive = false;
    eventScreenActive = false;

    // Inizializza gioco (prima in startGame)
    try {
        generateCharacter();
        if (!player || typeof player.vigore !== 'number') throw new Error("Player Gen Fail");
        console.log("Char OK", player);
        generateMap();
        if (!map || map.length === 0 || typeof player.x !== 'number') throw new Error("Map/Pos Gen Fail");
        console.log("Map OK, Player Pos:", player.x, player.y);
    } catch(e) {
        console.error("INIT ERR:", e);
        if(mapDisplay) mapDisplay.textContent = `ERRORE INIZIALIZZAZIONE: ${e.message}`;
        return; // Ferma se l'inizializzazione fallisce
    }

    gameActive = true;
    eventOverlay.style.display = 'none';

    // Render UI (prima in startGame)
    try {
        renderLegend();
        renderStats();
        renderMap(); // Render mappa dopo che posizione player è definita
        renderMessages(); // Pulisce log precedente se c'era
        addMessage(`Inizio viaggio. HP:${player.hp}, Cibo:${player.food}, Acqua:${player.water}`);
        console.log("Initial Render OK");
    } catch (e) {
        console.error("RENDER ERR:", e);
        if(mapDisplay) mapDisplay.textContent = "Errore nel rendering iniziale!";
        gameActive = false; // Impedisce di giocare se il rendering fallisce
    }

    if (gameActive) {
        enableControls();
        setupInputListeners(); // Imposta listener solo se il gioco è pronto
    }
    console.log("[proceedToGame] Game Setup Complete.");
}

function generateCharacter() {
    player={name:"Ultimo",vigore:9+getRandomInt(0,2),potenza:9+getRandomInt(0,2),agilita:14+getRandomInt(0,2),tracce:14+getRandomInt(0,2),influenza:6+getRandomInt(0,2),presagio:7+getRandomInt(0,2),adattamento:9+getRandomInt(0,2),acquisita:8+getRandomInt(0,2),maxHp:0,hp:0,x:undefined,y:undefined,food:STARTING_FOOD,water:STARTING_WATER,ammo:0,movesCounter:0}; player.maxHp=10+player.vigore; player.hp=player.maxHp;
}
function generateMap() {
    map = []; let sPos=null, ePos=null; for(let y=0;y<MAP_HEIGHT;y++){map[y]=[]; for(let x=0;x<MAP_WIDTH;x++){let t=TILE_SYMBOLS.PLAINS; const r=Math.random(); if(r<0.1)t=TILE_SYMBOLS.MOUNTAIN; else if(r<0.2)t=TILE_SYMBOLS.FOREST; else if(r<0.26)t=TILE_SYMBOLS.RIVER; else if(r<0.30)t=TILE_SYMBOLS.VILLAGE; else if(r<0.32)t=TILE_SYMBOLS.CITY; else if(r<0.35)t=TILE_SYMBOLS.REST_STOP; map[y][x]={type:t,visited:false};}} let sx=getRandomInt(1,Math.floor(MAP_WIDTH/4)); let sy=getRandomInt(1,Math.floor(MAP_HEIGHT/4)); let att=0; while((!map[sy]?.[sx] || map[sy][sx].type!==TILE_SYMBOLS.PLAINS) && att<100){ sx=getRandomInt(1,Math.floor(MAP_WIDTH/4)); sy=getRandomInt(1,Math.floor(MAP_HEIGHT/4)); att++;} if(att>=100){sx=1;sy=1;} map[sy][sx]={type:TILE_SYMBOLS.START,visited:true}; sPos={x:sx,y:sy}; let ex,ey; att=0; do{ex=getRandomInt(Math.floor(MAP_WIDTH*3/4),MAP_WIDTH-2); ey=getRandomInt(Math.floor(MAP_HEIGHT*3/4),MAP_HEIGHT-2); att++; if(att>100){ex=MAP_WIDTH-2;ey=MAP_HEIGHT-2; break;}}while(!map[ey]?.[ex] || map[ey][ex].type===TILE_SYMBOLS.MOUNTAIN || map[ey][ex].type===TILE_SYMBOLS.RIVER || (ex===sx && ey===sy)); if(map[ey]?.[ex]){map[ey][ex]={type:TILE_SYMBOLS.END,visited:false};} else {map[MAP_HEIGHT-2][MAP_WIDTH-2]={type:TILE_SYMBOLS.END,visited:false};} player.x=sPos.x; player.y=sPos.y;
}

function renderStats() {
    try{statHp.textContent=player?.hp??'--';statMaxHp.textContent=player?.maxHp??'--';statVig.textContent=player?.vigore??'--';statPot.textContent=player?.potenza??'--';statAgi.textContent=player?.agilita??'--';statTra.textContent=player?.tracce??'--';statInf.textContent=player?.influenza??'--';statPre.textContent=player?.presagio??'--';statAda.textContent=player?.adattamento??'--';statAcq.textContent=player?.acquisita??'--';statFood.textContent=player?.food??'--';statWater.textContent=player?.water??'--';statFood.classList.toggle('low-resource',(player?.food??99)<=1);statWater.classList.toggle('low-resource',(player?.water??99)<=1);posX.textContent=player?.x??'--';posY.textContent=player?.y??'--';if(gameActive&&map?.[player?.y]?.[player?.x]){const t=map[player.y][player.x];tileType.textContent=TILE_DESC[t.type]||'???';}else if(gameActive){tileType.textContent='Inizio...';}else{tileType.textContent='--';}}catch(e){console.error("Err Stats:",e);if(tileType)tileType.textContent='ERR';}}
function renderMessages() {
    try{messagesList.innerHTML = messages.map(msg => `<li>${msg}</li>`).join('');}catch(e){console.error("Err Msgs:",e);}}
function renderLegend() {
    try{legendList.innerHTML=''; const li=[{s:TILE_SYMBOLS.PLAYER,d:TILE_DESC['@']},{s:TILE_SYMBOLS.PLAINS,d:TILE_DESC['.']},{s:TILE_SYMBOLS.FOREST,d:TILE_DESC['F']},{s:TILE_SYMBOLS.MOUNTAIN,d:TILE_DESC['M']},{s:TILE_SYMBOLS.RIVER,d:TILE_DESC['~']},{s:TILE_SYMBOLS.VILLAGE,d:TILE_DESC['V']},{s:TILE_SYMBOLS.CITY,d:TILE_DESC['C']},{s:TILE_SYMBOLS.REST_STOP,d:TILE_DESC['R']},{s:TILE_SYMBOLS.START,d:TILE_DESC['S']},{s:TILE_SYMBOLS.END,d:TILE_DESC['E']}]; li.forEach(i=>{const tc=`tile-${Object.keys(TILE_SYMBOLS).find(k=>TILE_SYMBOLS[k]===i.s)?.toLowerCase().replace('_','-')||'unk'}`; const ec=i.s===TILE_SYMBOLS.END?'tile-end':''; legendList.innerHTML+=`<li><span class="legend-symbol ${tc} ${ec}">${i.s}</span> = ${i.d}</li>`;});}catch(e){console.error("Err Legend:",e);}}
function renderMap() {
    const d=mapDisplay; if(!d)return; if(!player||typeof player.x!=='number'){d.textContent="ERR Player"; return;} if(!map||!map.length){d.textContent="ERR Map"; return;} player.x=Math.max(0, Math.min(MAP_WIDTH-1, player.x)); player.y=Math.max(0, Math.min(MAP_HEIGHT-1, player.y)); let s=""; const vw=40,vh=25,hw=Math.floor(vw/2),hh=Math.floor(vh/2); let sx=Math.max(0,player.x-hw), sy=Math.max(0,player.y-hh); sx=Math.min(sx,MAP_WIDTH-vw); sy=Math.min(sy,MAP_HEIGHT-vh); sx=Math.max(0,sx); sy=Math.max(0,sy); let ex=Math.min(MAP_WIDTH,sx+vw), ey=Math.min(MAP_HEIGHT,sy+vh); try{for(let y=sy; y<ey; y++){if(y<0||y>=map.length)continue; for(let x=sx; x<ex; x++){if(x<0||!map[y]||x>=map[y].length)continue; if(x===player.x && y===player.y){s+=`<span class="player-marker">${TILE_SYMBOLS.PLAYER}</span>`;} else {const t=map[y][x];const symb=t?.type||'?';let tclass=`tile-${Object.keys(TILE_SYMBOLS).find(k=>TILE_SYMBOLS[k]===symb)?.toLowerCase().replace(/_/g,'-')||'unk'}`; let vclass=t?.visited?'visited':''; let eclass=symb===TILE_SYMBOLS.END?'tile-end':''; s+=`<span class="${tclass} ${vclass} ${eclass}">${symb}</span>`;}}s+="\n";}}catch(e){console.error(e); d.textContent="Err Render Loop!"; return;} d.innerHTML=s;}

function disableControls(disabled=true){moveButtons.forEach(btn=>btn.disabled=disabled);}
function enableControls(){if(gameActive)moveButtons.forEach(btn=>btn.disabled=false);}
function performSkillCheck(statKey, difficulty){const val=player[statKey]||5; const roll=getRandomInt(1,20); const bonus=Math.floor((val-10)/2); const total=roll+bonus; const success=total>=difficulty; const txt=`Prova ${statKey.toUpperCase()}(D${difficulty}): D${roll}+${bonus}=${total} -> ${success?"SUCCESSO!":'<span class="danger-text">FALLIMENTO!</span>'}`; return{success, text:txt};}

function showEventPopup(title, content, choices=[], checkResult=null, consequenceText="") {
    // Limita la visualizzazione dei popup se il gioco è finito, tranne per le schermate finali
    if (!gameActive && !title.includes("Fine") && !title.includes("Destinazione")) return;
    eventTitle.textContent=title; let choiceHTML=""; let fullHTML=content.replace(/\n/g,'<br>'); if(checkResult){fullHTML+=`<br>${checkResult.text}`; if(consequenceText){fullHTML+=`<br>${consequenceText.replace(/\n/g,'<br>')}`;}}else if(consequenceText&&!checkResult){fullHTML+=`<br>${consequenceText.replace(/\n/g,'<br>')}`;} if(choices?.length>0){currentEventChoices=choices;choices.forEach(c=>{choiceHTML+=`<div class="event-choice"><span class="event-choice-key">[${c.key}]</span> ${c.text}</div>`;});continueButton.classList.add('hidden');}else{currentEventChoices=[];currentEventContext=null;continueButton.classList.remove('hidden');} eventContent.innerHTML=fullHTML+choiceHTML; eventOverlay.style.display='block'; disableControls(true); eventScreenActive=true; eventContent.scrollTop=eventContent.scrollHeight;
}
function hideEventScreen(){if(!gameActive && eventScreenActive) { /* Potrebbe servire logica specifica se il gioco finisce con popup aperto? */ } if(!eventScreenActive) return; eventOverlay.style.display='none';eventScreenActive=false;currentEventChoices=[];currentEventContext=null; if(gameActive) enableControls();}

function showEndGameMessage(isVictory){
    gameActive=false;disableControls(true);eventOverlay.style.display='none';gameContainer.style.display='none';splashScreen.style.display='none';
    if(isVictory){
        endTitle.textContent="Destinazione Raggiunta...";
        // Testo Vittoria Specifico
        endMessage.innerHTML=`...Sei arrivato. Davanti a te, una vecchia porta blindata semi-sepolta, con uno strano simbolo inciso... Il simbolo di tuo padre... L\'aria all\'interno è viziata... Un terminale spento è incassato nella parete... È questo il \'Safe Place\'? ...Il tuo viaggio per ora termina qui, Ultimo. Ma la storia... sembra appena iniziata. (Fine del Prototipo - Capitolo 1)`.replace(/\n/g, '<br>');
    } else {
        endTitle.textContent="Il Viaggio Termina Qui";
        // Testo Sconfitta Specifico
        endMessage.textContent="Le ferite, la fame, la disperazione... Questo mondo non perdona. Sei caduto, Ultimo. Le rovine reclamano un\'altra vita. La ricerca del Safe Place finisce nell\'oblio.";
    }
    endScreen.style.display='flex';
}

function handleTileEvent(tile) {
    if (!tile || !gameActive) return false;
    tile.visited = true;
    const t = tile.type;
    let title = "", desc = "", popup = false, changed = false, choices = [], check = null, cons = "", immediateEvent = false;
    addMessage(`Entri: ${TILE_DESC[t] || '???'}`);

    // Probabilità base per eventi casuali sulla tile (prima di eventi specifici)
    let baseEventChance = 0;
    let allowedEventsOnTile = [];
    switch(t) {
        case TILE_SYMBOLS.PLAINS: baseEventChance = 0.08; allowedEventsOnTile = ['animale', 'loot_semplice', 'lore']; break; // Aggiunto lore
        case TILE_SYMBOLS.FOREST: baseEventChance = 0.25; allowedEventsOnTile = ['animale', 'tracce_strane', 'pericolo_ambientale', 'lore', 'dilemma_morale']; break; // Aumentata chance, aggiunto dilemma
        case TILE_SYMBOLS.MOUNTAIN: baseEventChance = 0.20; allowedEventsOnTile = ['animale', 'pericolo_ambientale', 'lore']; break; // Aggiunto lore
        case TILE_SYMBOLS.RIVER: baseEventChance = 0.05; allowedEventsOnTile = ['loot_semplice']; break;
        case TILE_SYMBOLS.CITY: baseEventChance = 0.65; allowedEventsOnTile = ['predoni', 'animale', 'tracce_strane', 'loot_semplice', 'lore', 'pericolo_ambientale', 'dilemma_morale']; break; // Aumentata chance, aggiunto dilemma
        case TILE_SYMBOLS.VILLAGE: baseEventChance = 0.50; allowedEventsOnTile = ['villaggio_ostile', 'loot_semplice', 'lore', 'tracce_strane', 'dilemma_morale']; break; // Aumentata chance, aggiunto tracce/dilemma
    }

    // Controlla se scatta un evento casuale GENERICO sulla tile
    if (baseEventChance > 0 && Math.random() < baseEventChance) {
        triggerRandomEvent(allowedEventsOnTile);
        return false; // L'evento casuale gestirà il popup
    }

    // Flavor text per tiles comuni (senza popup)
    let flavor = "";
    if (Math.random() < 0.20) { // Aumentata probabilità flavor text
        switch (t) {
            case TILE_SYMBOLS.FOREST: flavor = getRandomText(flavorTextsForest); break;
            case TILE_SYMBOLS.MOUNTAIN: flavor = getRandomText(flavorTextsMountain); break;
            case TILE_SYMBOLS.RIVER: flavor = getRandomText(flavorTextsRiver); break;
            case TILE_SYMBOLS.CITY: flavor = getRandomText(flavorTextsCity); break;
            case TILE_SYMBOLS.VILLAGE: flavor = getRandomText(flavorTextsVillage); break;
            case TILE_SYMBOLS.PLAINS: if(!popup) flavor = getRandomText(flavorTextsPlains); break;
            case TILE_SYMBOLS.REST_STOP: if(!popup) flavor = getRandomText(flavorTextsRestStop); break;
        }
        if (flavor) addMessage(flavor);
    }

    // Logica eventi specifici per tile (che non sono stati coperti da eventi casuali sopra)
    switch (t) {
        case TILE_SYMBOLS.REST_STOP:
            title = "Rifugio Improvvisato";
            desc = "Questo luogo sembra offrire un po' di tregua. Cerchi di recuperare le forze.";
            check = performSkillCheck('adattamento', 10);
            let foundSomething = false; // Flag per sapere se mostrare la scelta successiva
            if (check.success) {
                cons = "Riesci a riposare bene.";
                if (player.hp < player.maxHp) {
                    player.hp = Math.min(player.hp + 1, player.maxHp);
                    cons += " Recuperi 1 HP.";
                    changed = true;
                }
                if (Math.random() < 0.5) {
                     if (Math.random() < 0.5) { player.food++; cons += " Trovi del cibo (+1 Cibo)."; }
                     else { player.water++; cons += " Trovi dell'acqua (+1 Acqua)."; }
                     changed = true;
                }
                // Solo se il check ha successo, c'è la possibilità di notare qualcosa
                if (Math.random() < 0.4) { // 40% chance di notare qualcosa
                     desc += `\n${cons}\n${getRandomText(descrizioniRifugioStrano)}`; // Aggiunge la descrizione di cosa si nota
                     choices = [
                         { key: 'I', text: "Ispeziona" },
                         { key: 'L', text: "Lascia perdere" }
                     ];
                     currentEventContext = { event: 'rifugio_scelta', difficulty: 11, checkResult: check }; // Salva contesto per la scelta
                     cons = ""; // Conseguenza gestita nella scelta
                     foundSomething = true;
                } else {
                     // Successo nel riposo ma non notato nulla di strano
                     desc += `\n${cons}`;
                }
            } else {
                cons = "Il luogo è più scomodo di quanto sembri. Non riesci a riposare bene.";
                desc += `\n${cons}`; // Aggiunge la conseguenza al desc principale
                // Nessuna scelta se il check iniziale fallisce
            }
            popup = true;
            immediateEvent = true; // Mostra subito il popup (con o senza scelte)
            break;
        case TILE_SYMBOLS.VILLAGE:
             if (!popup && !flavor) {
                 addMessage(getRandomText(flavorTextsVillage) || "L'accampamento è stranamente silenzioso.");
             }
            break;
        case TILE_SYMBOLS.CITY:
             if (!popup && !flavor) {
                 addMessage(getRandomText(flavorTextsCity) || "Le rovine si estendono a perdita d'occhio.");
             }
            break;
        case TILE_SYMBOLS.END:
            if (gameActive) showEndGameMessage(true);
            return false;
    }

    // Controllo finale anti-spam
    if (eventScreenActive && title === "Rifugio Improvvisato") {
        addMessage("Decidi di non fermarti al rifugio, c'è altro che richiede la tua attenzione.");
        return false;
    }

    if (changed) {
        renderStats();
    }
    // Mostra popup solo se generato direttamente qui E non c'è un altro evento in corso E non ci sono scelte (altrimenti la scelta gestirà il popup)
    if (popup && immediateEvent && !eventScreenActive && choices.length === 0) {
        showEventPopup(title, desc, [], check, cons); // Mostra check iniziale del rifugio se non c'erano scelte
        return true;
    } else if (popup && immediateEvent && !eventScreenActive && choices.length > 0) {
        // Se ci sono scelte, mostra il popup con le scelte (senza check/cons iniziali, quelli vanno nel contesto)
        showEventPopup(title, desc, choices, null, "");
        return true; // C'è un popup con scelte
    }
    return false;
}

function triggerRandomEvent(allowedTypes = ['predoni', 'animale', 'tracce_strane', 'loot_semplice', 'lore', 'pericolo_ambientale', 'dilemma_morale']) {
    if (!gameActive || eventScreenActive || allowedTypes.length === 0) return;
    let type = allowedTypes[getRandomInt(0, allowedTypes.length - 1)];
    let title = "Evento Inaspettato", desc = "", changed = false, choices = [], check = null, cons = "";
    currentEventContext = { event: type };

    if (type !== 'lore' && type !== 'loot_semplice') {
        addMessage(`[EVENTO] ${type.replace('_', ' ')}!`, 'info', true);
    }

    switch (type) {
        case 'predoni':
            title = "Predoni!"; desc = `${getRandomText(descrizioniPredoni)} ${getRandomText(vociPredoni)}\nTi bloccano la strada!`; choices = [{ key: 'F', text: "Fuggi (Agilità)" },{ key: 'C', text: "Combatti (Potenza)" },{ key: 'P', text: "Parla (Influenza)" }]; currentEventContext.difficulty = 12;
            break;
        case 'animale':
            title = "Animale Selvatico!"; const animale = getRandomText(descrizioniAnimali); desc = `Un ${animale} ti sbarra il passo, ringhiando.`; choices = [{ key: 'E', text: "Evita (Agilità/Tracce)" },{ key: 'S', text: "Spaventa (Influenza)" },{ key: 'A', text: "Attacca (Potenza)" }]; currentEventContext.difficulty = 11;
            break;
        case 'tracce_strane':
            title = "Tracce Strane"; desc = getRandomText(descrizioniTracce); choices = [{ key: 'I', text: "Ignora" },{ key: 'S', text: "Segui (Tracce)" }]; currentEventContext.difficulty = 13;
            break;
        case 'villaggio_ostile':
            title = "Accampamento Ostile"; desc = getRandomText(descrizioniVillaggioOstile); choices = [{ key: 'A', text: "Allontanati" },{ key: 'N', text: "Negozia (Influenza)" }]; currentEventContext.difficulty = 14;
            break;
        case 'loot_semplice':
            title = "Oggetti Abbandonati";
            const lootType = Math.random() < 0.6 ? 'Cibo' : 'Acqua';
            const amount = getRandomInt(1, 3); // Aumentata quantità max a 3
            desc = `Frugando in giro, trovi ${amount} unità di ${lootType} in un contenitore nascosto.`;
            if (lootType === 'Cibo') player.food += amount;
            else player.water += amount;
            changed = true;
            choices = [];
            addMessage("Hai trovato delle provviste.", 'info'); // Logga nel pannello
            break;
        case 'lore':
            title = "Eco dal Passato"; desc = `Trovi un frammento di conoscenza perduta:\n"${getRandomText(loreFragments)}"`; addMessage("Hai trovato un frammento di lore.", 'info'); choices = [];
            break;
        case 'pericolo_ambientale':
            title = "Pericolo Improvviso!";
            const hazardType = Math.random();
            if (hazardType < 0.5) {
                 desc = getRandomText(descrizioniPericoloAmbientaleAgilita);
                 choices = [ { key: 'S', text: "Schiva (Agilità)" } ];
                 currentEventContext.subType = 'agilita_check';
                 currentEventContext.difficulty = 12;
                 currentEventContext.damage = getRandomInt(1, 2);
            } else {
                desc = getRandomText(descrizioniPericoloAmbientalePresagio);
                choices = [ { key: 'R', text: "Reagisci (Presagio)" } ];
                currentEventContext.subType = 'presagio_check';
                currentEventContext.difficulty = 13;
                currentEventContext.damage = getRandomInt(1, 3);
            }
            break;
        case 'dilemma_morale': // NUOVO EVENTO
            title = "Dilemma Morale";
            desc = getRandomText(descrizioniDilemmaMorale);
            choices = [
                { key: 'I', text: "Indaga / Intervieni (Presagio?)" },
                { key: 'N', text: "Non è affar mio / Ignora" }
            ];
            currentEventContext.difficulty = 12; // Difficoltà base per indagare con successo?
            break;
        default:
            title = "Nulla di Fatto"; desc = "Senti uno strano rumore, ma non succede nulla."; choices = [];
            break;
    }

    if (changed) { // Per loot_semplice
        renderStats();
    }
    showEventPopup(title, desc, choices, check, cons);
}

function handleEventChoice(choiceKey) {
    let title = "Esito", desc = "", changed = false, choices = [], check = null, cons = "";
    const ctx = currentEventContext;
    hideEventScreen(); // Nasconde il popup precedente

    if (!ctx) { console.error("handleEventChoice chiamato senza context!"); addMessage("Errore nell'elaborazione dell'evento.", 'warning'); return; }

    console.log(`Handling choice ${choiceKey} for event ${ctx.event}`);

    switch (ctx.event) {
        case 'predoni':
            title = "Scontro con Predoni";
            switch (choiceKey) {
                case 'F':
                    check = performSkillCheck('agilita', ctx.difficulty);
                    if (check.success) { desc = getRandomText(esitiFugaPredoniOk); }
                    else { desc = getRandomText(esitiFugaPredoniKo); const dmg = getRandomInt(1, 3); player.hp = Math.max(0, player.hp - dmg); cons = `Vieni colpito (-${dmg} HP).`; changed = true; }
                    break;
                case 'C':
                    check = performSkillCheck('potenza', ctx.difficulty + 1);
                    if (check.success) { desc = getRandomText(esitiLottaPredoniOk); }
                    else { desc = getRandomText(esitiLottaPredoniKo); const dmg = getRandomInt(2, 4); const lostFood = Math.min(player.food, getRandomInt(0, 1)); const lostWater = Math.min(player.water, getRandomInt(0, 1)); player.hp = Math.max(0, player.hp - dmg); player.food -= lostFood; player.water -= lostWater; cons = `Subisci danni (-${dmg} HP)`; if (lostFood > 0) cons += `, perdi cibo (-${lostFood})`; if (lostWater > 0) cons += `, perdi acqua (-${lostWater})`; cons += "."; changed = true; }
                    break;
                case 'P':
                    check = performSkillCheck('influenza', ctx.difficulty + 2);
                    if (check.success) { desc = getRandomText(esitiParlaPredoniOk); }
                    else { desc = getRandomText(esitiParlaPredoniKo); const dmg = getRandomInt(2, 4); const lostFood = Math.min(player.food, getRandomInt(0, 2)); const lostWater = Math.min(player.water, getRandomInt(0, 2)); player.hp = Math.max(0, player.hp - dmg); player.food -= lostFood; player.water -= lostWater; cons = `Subisci danni (-${dmg} HP)`; if (lostFood > 0) cons += `, perdi cibo (-${lostFood})`; if (lostWater > 0) cons += `, perdi acqua (-${lostWater})`; cons += "."; changed = true; }
                    break;
            }
            break;

        case 'animale':
            title = "Incontro con Animale";
             switch (choiceKey) {
                case 'E':
                    const statToUse = player.agilita > player.tracce ? 'agilita' : 'tracce'; check = performSkillCheck(statToUse, ctx.difficulty);
                    if (check.success) { desc = getRandomText(esitiEvitaAnimaleOk); }
                    else { desc = getRandomText(esitiEvitaAnimaleKo); cons = "L'animale ti attacca!"; const dmg = getRandomInt(1, 2); player.hp = Math.max(0, player.hp - dmg); cons += ` (-${dmg} HP).`; changed = true; }
                    break;
                case 'S':
                    check = performSkillCheck('influenza', ctx.difficulty);
                    if (check.success) { desc = getRandomText(esitiSpaventaAnimaleOk); }
                    else { desc = getRandomText(esitiSpaventaAnimaleKo); cons = "La bestia si infuria e attacca!"; const dmg = getRandomInt(1, 3); player.hp = Math.max(0, player.hp - dmg); cons += ` (-${dmg} HP).`; changed = true; }
                    break;
                case 'A':
                    check = performSkillCheck('potenza', ctx.difficulty);
                    if (check.success) { desc = "Riesci a respingere l'animale."; }
                    else { desc = getRandomText(esitiAttaccoAnimaleKo); const dmg = getRandomInt(2, 4); player.hp = Math.max(0, player.hp - dmg); cons = `Vieni ferito (-${dmg} HP).`; changed = true; }
                    break;
            }
            break;

        case 'tracce_strane':
            title = "Seguendo le Tracce";
            if (choiceKey === 'I') { desc = "Decidi di non rischiare e prosegui per la tua strada."; }
            else if (choiceKey === 'S') {
                check = performSkillCheck('tracce', ctx.difficulty);
                if (check.success) {
                    const outcomeRoll = Math.random();
                    if (outcomeRoll < 0.35) { // 35% Trova loot
                         const foundLootType = Math.random() < 0.5 ? 'Cibo' : 'Acqua'; const foundAmount = getRandomInt(1, 3);
                         desc = `${getRandomText(esitiSeguiTracceOkLoot)} Trovi ${foundAmount} ${foundLootType}.`;
                         if (foundLootType === 'Cibo') player.food += foundAmount; else player.water += foundAmount; changed = true;
                    } else if (outcomeRoll < 0.55) { // 20% Trova Lore
                        desc = `${getRandomText(esitiSeguiTracceOkLore)}\n"${getRandomText(loreFragments)}"`;
                        addMessage("Hai trovato della lore seguendo le tracce.", 'info');
                    } else if (outcomeRoll < 0.80) { // 25% Pericolo (Predoni)
                        desc = getRandomText(esitiSeguiTracceOkPredoni);
                        triggerRandomEvent(['predoni']); return; // Innesca altro evento
                    } else { // 20% Nulla
                        desc = getRandomText(esitiSeguiTracceOkNulla);
                    }
                } else {
                    desc = getRandomText(esitiSeguiTracceKo);
                    // Penalità per fallimento? Es. piccolo danno?
                    if(Math.random() < 0.3) { // 30% chance di piccola penalità
                         const dmg = 1; player.hp = Math.max(0, player.hp - dmg);
                         cons = `La disattenzione ti costa cara (-${dmg} HP).`; changed = true;
                    }
                }
            }
            break;

         case 'villaggio_ostile':
            title = "Accampamento Guardingo";
            if (choiceKey === 'A') { desc = getRandomText(esitiVillaggioOstileAllontanati); }
            else if (choiceKey === 'N') {
                check = performSkillCheck('influenza', ctx.difficulty);
                if (check.success) { desc = getRandomText(esitiVillaggioOstileNegoziaOk); }
                else { desc = getRandomText(esitiVillaggioOstileNegoziaKo); /* Penalità? */ }
            }
            break;

        case 'pericolo_ambientale':
             title = "Esito Pericolo";
             let skill = 'agilita'; if (ctx.subType === 'presagio_check') skill = 'presagio';
             check = performSkillCheck(skill, ctx.difficulty);
             if (check.success) { desc = getRandomText(esitiPericoloAmbientaleEvitato); }
             else { desc = getRandomText(esitiPericoloAmbientaleColpito); player.hp = Math.max(0, player.hp - ctx.damage); cons = `Subisci ${ctx.damage} HP di danno.`; changed = true; }
             break;

        case 'dilemma_morale': // NUOVA GESTIONE
             title = "Conseguenze";
             if (choiceKey === 'N') {
                 desc = getRandomText(esitiDilemmaMoraleIgnora);
                 // Possibile conseguenza negativa futura per aver ignorato? (Non implementato)
             } else if (choiceKey === 'I') {
                 check = performSkillCheck('presagio', ctx.difficulty); // Usiamo presagio per intuire se intervenire è una buona idea?
                 if (check.success) {
                     // Esito positivo (loot/aiuto/lore?)
                     desc = getRandomText(esitiDilemmaMoraleIndagaOkPositivo);
                     // Aggiungi potenziale loot o altro beneficio qui
                     if(Math.random() < 0.5) { player.food += getRandomInt(1,2); cons = "Trovi del cibo."; changed = true; }
                 } else {
                     // Esito negativo (trappola/ferito/troppo tardi)
                      desc = getRandomText(esitiDilemmaMoraleIndagaOkNegativo);
                      // Aggiungi potenziale danno o altro malus qui
                      if(Math.random() < 0.5) { const dmg = getRandomInt(1,3); player.hp = Math.max(0, player.hp - dmg); cons = `Vieni ferito (-${dmg} HP).`; changed = true;}
                 }
             }
             break;

        case 'rifugio_scelta': // NUOVA GESTIONE SCELTA RIFUGIO
             title = "Ispezione Rifugio";
             // Recupera il check iniziale dal contesto per mostrarlo
             check = ctx.checkResult; // Mostra il tiro sull'Adattamento fatto prima
             if(choiceKey === 'L') {
                 desc = getRandomText(esitiRifugioLasciaPerdere);
             } else if (choiceKey === 'I') {
                 const inspectRoll = Math.random();
                 if (inspectRoll < 0.4) { // 40% Trova Loot
                     desc = getRandomText(esitiRifugioIspezionaOkLoot);
                     // Aggiungi loot specifico qui
                     if (desc.includes("cibo")) { player.food += getRandomInt(1,2); changed = true;}
                     else if (desc.includes("munizioni")) { player.ammo = (player.ammo || 0) + getRandomInt(2,5); changed = true;} // Assumendo che ammo esista
                     else if (desc.includes("acqua")) { player.water += 1; changed = true;}
                 } else if (inspectRoll < 0.6) { // 20% Trova Lore
                     desc = `${getRandomText(esitiRifugioIspezionaOkLore)}\n"${getRandomText(loreFragments)}"`;
                     addMessage("Hai trovato della lore nel rifugio.", "info");
                 } else if (inspectRoll < 0.8) { // 20% Trappola/Pericolo
                     desc = getRandomText(esitiRifugioIspezionaKoTrappola);
                     const dmg = getRandomInt(1, 2); player.hp = Math.max(0, player.hp - dmg);
                     cons = `Vieni ferito (-${dmg} HP).`; changed = true;
                 } else { // 20% Nulla
                     desc = getRandomText(esitiRifugioIspezionaKoNulla);
                 }
             }
             break;

        default:
            console.warn(`Unhandled event type in handleEventChoice: ${ctx.event}`); desc = "L'esito di questa azione non è chiaro...";
            break;
    }

    if (changed) {
        renderStats();
        if (checkGameOver()) return;
    }
    showEventPopup(title, desc, [], check, cons);
}

function checkGameOver(){if(player.hp<=0 && gameActive){showEndGameMessage(false);return true;} return false;}
function movePlayer(dx, dy){if(!gameActive||eventScreenActive)return; const nX=player.x+dx, nY=player.y+dy; if(nX<0||nX>=MAP_WIDTH||nY<0||nY>=MAP_HEIGHT){addMessage("Bloccato.");return;} player.x=nX; player.y=nY; player.movesCounter++; let consumed=false, penalty=false, renderStat=false; if(player.movesCounter>=CONSUMPTION_RATE){consumed=true; player.food=Math.max(0,player.food-1); player.water=Math.max(0,player.water-1); addMessage("Consumi provviste."); player.movesCounter=0; if(player.food===0){player.hp=Math.max(0,player.hp-1); addMessage("[ATTENZIONE] Fame! (-1 HP)",'info',true); penalty=true;} if(player.water===0){player.hp=Math.max(0,player.hp-1); addMessage("[ATTENZIONE] Sete! (-1 HP)",'info',true); penalty=true;} renderStat=true;} const tile=map[player.y]?.[player.x]; if(!tile)return; const popupHandledByTile = handleTileEvent(tile); if(checkGameOver())return; /*Modifica: checkGameOver dopo handleTileEvent*/ if(renderStat){renderStats();} if(!popupHandledByTile && !eventScreenActive){renderMap(); if(!renderStat)renderStats();} /*Modifica: render solo se non c'è popup*/}
function handleKeyPress(event){if(eventScreenActive && !event.repeat && currentEventChoices.length>0){ const key=event.key.toUpperCase(); const choice=currentEventChoices.find(c=>c.key===key); if(choice){event.preventDefault();handleEventChoice(key);}} else if(gameActive&&!eventScreenActive && !event.repeat){ let dx=0,dy=0; switch(event.key){case"ArrowUp":case"w":dy=-1;break; case"ArrowDown":case"s":dy=1;break; case"ArrowLeft":case"a":dx=-1;break; case"ArrowRight":case"d":dx=1;break; default:return;} event.preventDefault();movePlayer(dx,dy);}} // Corretto &¤t -> && ! e aggiunto !event.repeat
function setupInputListeners(){document.removeEventListener('keydown',handleKeyPress);document.addEventListener('keydown',handleKeyPress);}

// window.onload - Prepara solo l'essenziale per lo splash screen
window.onload = () => {
    mapDisplay.textContent = "Caricamento..."; // Messaggio generico iniziale
    // Non renderizzare stats/messaggi/legenda qui, verranno fatti da proceedToGame
};
    </script>

</body>
</html>