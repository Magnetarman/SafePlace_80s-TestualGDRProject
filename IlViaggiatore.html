
<!DOCTYPE html>
<html lang="it" style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Il Viaggiatore - Prototipo GDR (V0-605 Pulito)</title>
    <style>
        /* --- CSS Completo e Verificato --- */
        :root {
            --bg-color: #000000; --fg-color: #00FF00; --fg-dim-color: #009900;
            --border-color: #00FF00; --border-dim-color: #005500;
            --highlight-bg: #00FF00; --highlight-fg: #000000;
            --accent-color: #FFFF00; --danger-color: #FF4444;
            --overlay-bg: rgba(0, 10, 0, 0.97);
            --plains-color: #00BB00; --forest-color: #008800; --mountain-color: #339933;
            --water-color: #008888; --ruin-color: #55AA55; --special-color: #AAAA00;
            --end-color: var(--accent-color);
        }
        html { height: 100%; }
        body { background-color: var(--bg-color); color: var(--fg-color); font-family: 'Courier New', Courier, monospace; font-size: 16px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; height: 100%; box-sizing: border-box; overflow: hidden; }
        /* End Screen */
        #end-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--fg-color); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 99; display: none; padding: 20px; box-sizing: border-box; } /* Nascosto inizialmente */
        #end-message { white-space: pre-wrap; max-height: 80%; overflow-y: auto; margin-bottom: 20px; font-size: 1.1em; line-height: 1.4; text-align: left; padding: 0 10%; }
        #end-screen h2 { color: var(--accent-color); margin-bottom: 30px; }
        #end-screen button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 10px 20px; font-family: inherit; font-size: 1.1em; cursor: pointer; margin-top: 20px;}
        /* Game Container e Sezioni con TAG SEMANTICI */
        main#game-container { display: none; flex-direction: row; border: 2px solid var(--border-color); padding: 10px; box-sizing: border-box; position: relative; width: 100%; height: 100%; max-width: 1000px; max-height: 700px; background-color: var(--bg-color); overflow: hidden; }
        section#map-area { flex: 3; border-right: 1px dashed var(--border-color); padding-right: 10px; margin-right: 10px; display: flex; flex-direction: column; overflow: hidden; }
        #map-display { font-family: 'Courier New', Courier, monospace; white-space: pre; font-size: 18px; line-height: 1.1; margin-bottom: 10px; flex-grow: 1; overflow: auto; background-color: #050505; border: 1px solid var(--border-dim-color); padding: 5px; box-sizing: border-box; }
        /* Stili Colore Mappa */
        .tile-plains { color: var(--plains-color); } .tile-forest { color: var(--forest-color); } .tile-mountain { color: var(--mountain-color); } .tile-river { color: var(--water-color); } .tile-city, .tile-village { color: var(--ruin-color); } .tile-rest-stop, .tile-start { color: var(--special-color); } .tile-end { color: var(--end-color); font-weight: bold; }
        .visited { opacity: 0.6 !important; }
        .player-marker { animation: blink 1s step-end infinite; } @keyframes blink {0%,100%{background-color:var(--highlight-bg);color:var(--highlight-fg);}50%{background-color:transparent;color:var(--fg-color);}}
        #controls { text-align: center; margin-top: 5px; flex-shrink: 0; }
        #controls button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 5px 10px; margin: 2px; font-family: inherit; font-size: 14px; cursor: pointer; }
        #controls button:disabled { color: var(--border-dim-color); border-color: var(--border-dim-color); cursor: not-allowed; }
        section#status-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 220px; }
        #character-stats, #map-legend { margin-bottom: 15px; flex-shrink: 0; }
        #character-stats h3, #map-legend h3, #message-log h3 { margin-top: 0; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); padding-bottom: 3px; flex-shrink: 0; font-size: 1em; }
        #character-stats ul, #map-legend ul { list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        #character-stats li, #map-legend li { margin-bottom: 2px; white-space: nowrap; }
        #stat-food, #stat-water { font-weight: bold; } .low-resource { color: var(--danger-color); }
        #map-legend .legend-symbol { display: inline-block; width: 1.5em; text-align: center; font-weight: bold; }
        #message-log { border-top: 1px dashed var(--border-color); padding-top: 5px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; background-color: #050505; border: 1px solid var(--border-dim-color); padding: 5px; margin-top: 5px; min-height: 100px; }
        #messages { list-style: none; padding: 0; margin: 0; } #messages li { font-size: 0.9em; margin-bottom: 4px; word-break: break-word; } .log-warning { color: var(--danger-color); font-weight: bold;}
        /* Event Overlay */
         #event-overlay { display: none; position: absolute; top: 5%; left: 5%; width: 90%; height: 85%; background-color: var(--overlay-bg); border: 3px solid var(--border-color); color: var(--fg-color); z-index: 50; padding: 15px; box-sizing: border-box; font-size: 1em; overflow-y: auto; text-align: center; }
         #event-overlay h4 { margin-top: 0; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 15px; font-size: 1.2em; }
         #event-content { margin-bottom: 15px; text-align: left; white-space: pre-wrap; font-size: 0.95em; }
         .danger-text { color: var(--danger-color); font-weight: bold; }
         .event-choice { margin-top: 15px; text-align: center; }
         .event-choice button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 8px 15px; font-family: inherit; font-size: 0.95em; cursor: pointer; margin: 5px; display: inline-block; min-width: 150px; }
         .event-choice button:hover { background-color: var(--border-dim-color); }
         #event-overlay button.continue-button { background-color: #111; color: var(--fg-color); border: 1px solid var(--border-color); padding: 8px 15px; font-family: inherit; font-size: 0.9em; cursor: pointer; margin-top: 10px; }
        .hidden { display: none !important; }
        /* Media Query Mobile */
        @media (max-width: 700px) { body{align-items:stretch;} main#game-container{flex-direction:column; max-width:100%; max-height:none; height:100%; padding:5px; border:none;} section#map-area{flex:1 1 55%; border-right:none; border-bottom:1px dashed var(--border-color); padding-right:0; margin-right:0; margin-bottom:10px;} #map-display{font-size:14px; line-height:1.0;} #controls{order:1; margin-bottom:10px;} section#status-area{flex:1 1 45%; min-width:unset; width:100%; order:2;} #map-legend{display:none;} #message-log{font-size:0.85em;} #event-overlay{width:95%; left:2.5%; height:90%; top:2.5%; font-size:0.9em;} }
    </style>
</head>
<body style="height: 100%;">

    <!-- Schermata di Fine Gioco -->
    <div id="end-screen"> <h2 id="end-title">...</h2><div id="end-message">...</div><button onclick="window.location.reload()">Ricomincia il Viaggio</button> </div>

    <!-- Contenuto Principale -->
    <main id="game-container">
        <section id="map-area">
            <pre id="map-display">Attendere...</pre>
            <div id="controls"><button onclick="movePlayer(0, -1)" id="btn-up">Nord</button><br/><button onclick="movePlayer(-1, 0)" id="btn-left">Ovest</button><button onclick="movePlayer(1, 0)" id="btn-right">Est</button><br/><button onclick="movePlayer(0, 1)" id="btn-down">Sud</button></div>
        </section>
        <section id="status-area">
             <div id="character-stats"><h3>ULTIMO</h3><ul id="stats-list">
                <li>HP:<span id="stat-hp">--</span>/<span id="stat-maxhp">--</span></li>
                <li>Vigore:<span id="stat-vig">--</span></li>
                <li>Potenza:<span id="stat-pot">--</span></li>
                <li>Agilita':<span id="stat-agi">--</span></li>
                <li>Tracce:<span id="stat-tra">--</span></li>
                <li>Influenza:<span id="stat-inf">--</span></li>
                <li>Presagio:<span id="stat-pre">--</span></li>
                <li>Adattamento:<span id="stat-ada">--</span></li>
                <li>Acquisita:<span id="stat-acq">--</span></li>
                <li>Cibo:<span id="stat-food">--</span></li>
                <li>Acqua:<span id="stat-water">--</span></li>
                <li>Posizione:(<span id="pos-x">--</span>,<span id="pos-y">--</span>)</li>
                <li>Terreno:<span id="tile-type">--</span></li>
                <li id="stat-day-time-li">Tempo:<span id="stat-day-time">--</span></li>
            </ul></div>
             <div id="map-legend"><h3>LEGENDA</h3><ul id="legend-list"></ul></div>
             <div id="message-log"><ul id="messages"></ul><h3>LOG EVENTI</h3></div>
        </section>
        <div id="event-overlay"><h4 id="event-title">...</h4><div id="event-content">...</div><button onclick="hideEventScreen()" class="continue-button">Continua...</button></div>
    </main>

    <script>
        // --- CONFIGURAZIONE E COSTANTI ---
        const MAP_WIDTH = 50;
        const MAP_HEIGHT = 30;
        const MAX_MESSAGES = 30;
        const STARTING_FOOD = 7;
        const STARTING_WATER = 7;
        const DAY_LENGTH_MOVES = 18; // Numero di passi per far passare il giorno
        const NIGHT_FOOD_COST = 2;  // Costo cibo per riposo notturno
        const NIGHT_WATER_COST = 2; // Costo acqua per riposo notturno
        const HUNGER_PENALTY_HP = 1; // Danno HP per notte senza cibo
        const THIRST_PENALTY_HP = 1; // Danno HP per notte senza acqua

        const TILE_SYMBOLS = { PLAINS:'.', MOUNTAIN:'M', RIVER:'~', FOREST:'F', VILLAGE:'V', CITY:'C', REST_STOP:'R', START:'S', END:'E', PLAYER:'@' };
        const TILE_DESC = { '.':'Pianura desolata', 'M':'Montagne cicatrizzate', '~':'Fiume lento', 'F':'Foresta opprimente', 'V':'Accampamento isolato', 'C':'Rovine di città', 'R':'Rifugio improvvisato', 'S':"Punto d'inizio", 'E':'Destinazione incerta', '@':'Ultimo (Tu)' };

        // --- Testi Variabili (Flavor, Lore, Eventi) ---
        // (Nota: Questi array sono lunghi e rimangono invariati rispetto all'originale,
        // la loro esternalizzazione è un passo successivo consigliato)

        const flavorTextsPlains = [
            "Il vento solleva mulinelli di polvere rossastra che brucia gli occhi.",
            "Un silenzio innaturale grava su questa distesa brulla, pesante come un sudario.",
            "Ossa sbiancate dal sole, forse umane, affiorano dal terreno screpolato.",
            "Una carcassa di animale non identificabile giace lontana, divorata da sciami di insetti.",
            "Il cielo è un vasto oceano grigio e indifferente, senza un uccello in vista.",
            "Piccoli arbusti secchi e contorti si aggrappano disperatamente alla vita, come dita scheletriche.",
            "Una vecchia linea elettrica abbattuta serpeggia tra l'erba morta, un monumento inutile.",
            "Il terreno è duro e crepato sotto i tuoi piedi, assetato come te.",
            "Nessun segno di acqua o vita animale recente, solo il vuoto.",
            "Una sensazione di vuoto e isolamento ti pervade, sei un puntino nella desolazione.",
            "Il debole sole filtra appena attraverso una cappa di polvere costante, offrendo poco calore.",
            "Lo scheletro arrugginito di un veicolo agricolo affonda nel terreno, inghiottito dalla polvere.",
            "Una colonna di fumo si alza pigramente in lontananza... fuoco amico o nemico?",
            "Nuvole basse corrono veloci, promettendo una pioggia acida che non arriva mai."
        ];
        const flavorTextsForest = [
            "Rami secchi scricchiolano sinistramente sotto i tuoi stivali, annunciando la tua presenza.",
            "Un odore pungente di decomposizione e muffa riempie l'aria immobile, quasi soffocante.",
            "Il silenzio è rotto solo dal tuo respiro affannoso e dal battito martellante del tuo cuore.",
            "Intravedi un movimento fugace tra gli alberi fitti... un animale o qualcos'altro che osserva?",
            "Strani simboli luminescenti, quasi organici, pulsano debolmente sulla corteccia di un albero antico.",
            "La luce del sole filtra a fatica, creando lunghe ombre danzanti che ingannano la vista.",
            "Trovi i resti di un piccolo accampamento abbandonato in fretta, c'è odore di paura nell'aria.",
            "Muschio pallido ricopre tronchi e rocce come un sudario umido e freddo.",
            "Senti un basso ringhio provenire dalle profondità della foresta, troppo vicino per stare tranquillo.",
            "L'aria è pesante e immobile, sembra quasi difficile respirare in questa oscurità verde.",
            "Ragnatele innaturalmente grandi e spesse bloccano il sentiero, tessute da ragni mostruosi?",
            "Un fungo pallido e dall\'aspetto velenoso cresce alla base di un tronco marcio.",
            "Il verso rauco di un corvo solitario ti fa sussultare, un presagio?",
            "Un sentiero quasi invisibile si perde tra gli alberi, una promessa o una trappola?"
        ];
        const flavorTextsMountain = [
            "Un'eco lontana risuona tra le vette aguzze, portando con sé un suono inquietante, forse un lamento.",
            "Il sentiero è ripido, franoso e disseminato di rocce taglienti come rasoi.",
            "Un'aquila solitaria disegna ampi cerchi nel cielo plumbeo, osservandoti con fredda indifferenza.",
            "Senti il rumore di piccole pietre che rotolano in basso, smosse da chi o cosa si nasconde sopra di te?",
            "La carcassa congelata di uno scalatore sfortunato è un macabro monito contro l'arroganza.",
            "Il vento fischia tra le creste rocciose come un lamento spettrale, portando voci dal passato.",
            "Resti contorti di strutture metalliche si fondono con la roccia, cicatrici di una guerra dimenticata.",
            "La vista dalla cima è vasta e vertiginosa, ma mostra solo chilometri di desolazione senza fine.",
            "L'aria è rarefatta e pungente, ogni respiro è una piccola vittoria.",
            "Una caverna buia si apre sul fianco della montagna, promettendo riparo o diventando la tua tomba.",
            "Neve sporca e vecchia persiste nelle zone d\'ombra, un ricordo di inverni passati.",
            "Un passaggio stretto tra due pareti di roccia incombe su di te, minacciando di schiacciarti.",
            "Trovi vecchi segni di piccozza sulla roccia, testimonianza silenziosa di chi ti ha preceduto.",
            "Un rivolo d'acqua gelida sgorga da una fessura, un piccolo miracolo in questo nulla arido."
        ];
        const flavorTextsRiver = [
            "Detriti non identificabili e chiazze oleose galleggiano lentamente sull'acqua torbida.",
            "La riva fangosa risucchia i tuoi stivali ad ogni passo, rendendo l'avanzata faticosa.",
            "Un pesce deforme con troppi occhi galleggia a pancia in su, testimone della contaminazione.",
            "Il suono basso e costante dell'acqua che scorre è quasi ipnotico nel silenzio opprimente.",
            "I resti crollati di un vecchio ponte di cemento bloccano parzialmente il flusso, creando gorghi sinistri.",
            "Vedi delle bolle maleodoranti salire in superficie... gas naturale o il respiro di qualcosa sotto?",
            "L'acqua sembra stranamente calda al tatto, innaturale.",
            "L\'acqua ha un colore innaturale, verdastro e lattiginoso.",
            "La carcassa arrugginita di una barca da pesca è incagliata sulla riva opposta, un relitto solitario.",
            "Un gruppo di insetti mutati, grossi come il tuo pollice, ronza minacciosamente vicino all'acqua.",
            "Il letto del fiume è disseminato di oggetti contorti e irriconoscibili.",
            "Sulla riva opposta, vedi delle luci deboli tremolare... altri sopravvissuti o un inganno?",
            "L'acqua emana un leggero odore chimico che irrita le narici."
        ];
        const flavorTextsCity = [
            "Il vento geme lugubremente attraverso le finestre sfondate di grattacieli scheletrici.",
            "Un vecchio manifesto strappato raffigurante una famiglia sorridente sventola pateticamente da un muro crepato.",
            "Carcasse arrugginite di veicoli di ogni tipo formano barricate contorte e inutili lungo le strade.",
            "Un silenzio spettrale avvolge le strade deserte, rotto solo dai tuoi passi e dal crepitio dei detriti.",
            "Trovi una bambola rotta, con un occhio mancante e un sorriso inquietante, tra le macerie di una casa.",
            "Un monitor rotto emette ancora una debole luce statica verdastra, come un fantasma tecnologico.",
            "Graffiti criptici e simboli inquietanti coprono quasi ogni superficie verticale, messaggi dai folli o dagli avvertiti.",
            "L'odore acre di bruciato e decomposizione persiste nell'aria, un profumo costante di morte.",
            "Il terreno è disseminato di bossoli, schegge di vetro e frammenti d'ossa.",
            "Hai la costante, spiacevole sensazione di essere osservato dalle migliaia di finestre vuote.",
            "Polvere di cemento ti irrita gli occhi e la gola, rendendo ogni respiro difficoltoso.",
            "Un semaforo dondola precariamente da un palo piegato, bloccato su un rosso eterno.",
            "Un negozio di lusso saccheggiato, manichini nudi e vetrine infrante giacciono come corpi."
        ];
        const flavorTextsVillage = [
            "Tende strappate e ripari improvvisati fatti di lamiere sbattono tristemente al vento gelido.",
            "Un fuoco da campo spento da tempo, con pentole arrugginite e ossa animali sparse intorno.",
            "Oggetti personali – una scarpa da bambino, un libro ammuffito, una foto sbiadita – giacciono abbandonati nella polvere.",
            "Non c'è alcun segno di vita recente, solo il silenzio della desolazione e l'odore della morte.",
            "Un'atmosfera pesante grava sull'accampamento, come se qualcosa di terribile fosse accaduto qui di recente.",
            "Resti di barricate rudimentali e macchie scure sul terreno suggeriscono un passato violento.",
            "Una pentola ammaccata giace vicino alla cenere fredda, l'ultimo pasto mai consumato.",
            "Qualcuno ha cercato disperatamente di fortificare questo posto, ma le difese sono state violate.",
            "L\'aria odora di polvere, abbandono e un sottile sentore di malattia.",
            "Piccoli cumuli di terra smossa con croci improvvisate... tombe fresche.",
            "Un carillon rotto suona una melodia stonata quando il vento lo colpisce.",
            "Le tende vuote sembrano bocche spalancate che urlano in silenzio."
        ];
        const flavorTextsRestStop = [
            "Il riparo è precario, un ammasso di lamiere contorte, teli laceri e detriti vari.",
            "Qualcuno ha lasciato segni del suo passaggio qui: scritte sui muri ('NON DORMIRE'), piccoli oggetti rituali.",
            "Puzza intensamente di vecchio fumo stantio, urina secca e umidità stagnante.",
            "Sembra relativamente sicuro dall'esterno, ma l'interno suscita un senso di disagio.",
            "Trovi un piccolo giaciglio improvvisato fatto di stracci, sembra usato di recente... troppo di recente.",
            "Il silenzio qui è diverso, più opprimente, come se le pareti avessero assorbito urla.",
            "Il tetto gocciola un liquido scuro e oleoso anche se non piove.",
            "Trovi delle scritte sul muro: 'Giorni sopravvissuti: 12', poi '13', poi un graffio profondo che cancella tutto.",
            "Un materasso sporco e strappato è buttato in un angolo, macchiato di qualcosa di scuro.",
            "Una singola lattina vuota e ammaccata rotola sul pavimento quando entri, producendo un rumore assordante.",
            "C'è un debole odore dolciastro e sgradevole nell'aria... prodotti chimici o decomposizione?",
            "Le pareti sono coperte di disegni infantili inquietanti e simboli sconosciuti."
        ];
        const flavorTextsNightPlains = [
            "Un silenzio innaturale e profondo avvolge la pianura sotto la luna malata.",
            "La luna proietta ombre lunghe e distorte che sembrano creature striscianti.",
            "Il vento notturno sussurra strane melodie tra l'erba secca, portando voci che non ci sono.",
            "Senti un fruscio improvviso vicino a te, ma quando ti giri non c'è nulla... o quasi.",
            "Le stelle sembrano fredde, aguzze e terribilmente lontane, osservatori impassibili.",
            "Ogni tanto, un grido lontano e disumano rompe la quiete, facendo accapponare la pelle.",
            "L'oscurità sembra viva, densa, pronta a inghiottire la debole luce della tua torcia.",
            "Una forma indistinta si muove rapidamente all'orizzonte, troppo veloce per essere naturale.",
            "Il terreno sembra respirare lentamente nell'oscurità, come il fianco di una bestia addormentata.",
            "Senti il freddo della notte penetrare nelle ossa, portando con sé una stanchezza mortale.",
            "Luci fatue danzano in lontananza, spiriti o gas di palude?",
            "L'orizzonte sembra infinito e vuoto, non c'è riparo in vista."
        ];
        const flavorTextsNightForest = [
            "Ogni scricchiolio di ramo secco ti fa sobbalzare, il cuore in gola.",
            "Forme indistinte e contorte sembrano muoversi furtivamente tra gli alberi ai margini della vista.",
            "Un odore metallico e dolciastro si diffonde nell'aria fredda della notte... sangue?",
            "Il buio della foresta è quasi totale, denso e opprimente come terra umida.",
            "Senti il battito d'ali pesanti di qualcosa di grosso che vola silenziosamente sopra la tua testa.",
            "Un paio di occhi gialli e innaturali ti fissano intensamente dal buio prima di sparire con uno scatto.",
            "La foresta di notte sembra viva, ostile, ogni albero un potenziale nascondiglio per l'orrore.",
            "Inciampi su una radice nodosso nascosta dall'ombra, rischiando di cadere.",
            "Un sussurro gelido sembra seguire i tuoi passi, pronunciando il tuo nome... o forse no.",
            "La luna filtra a malapena tra le fitte chiome, creando giochi di luce e ombra inquietanti e ingannevoli.",
            "Senti un respiro rauco e umido molto vicino, ma non riesci a localizzarlo.",
            "Il silenzio è così teso che puoi sentire il sangue pulsare nelle orecchie."
        ];
        const loreFragments = [
            "Pagina strappata di diario: '... giorno 47. Le scorte sono finite. Ho sentito di un posto sicuro a est, oltre le montagne spezzate. Forse è solo una favola per disperati come me, ma è la mia ultima speranza...'",
            "Pezzo di metallo inciso a laser: 'Progetto Chimera - Soggetto #007 - Proprietà della Volta 7 - TERMINATO'",
            "Ologramma tremolante da un dispositivo rotto: '...protocollo di contenimento fallito... bio-agente [CLASSIFICATO] fuori controllo... Evacuare immediatamente... che Dio ci aiuti...'",
            "Scheda dati danneggiata e macchiata: '...mutazione instabile di Tipo IV... aggressività esponenziale... protocollo suggerito: eliminare a vista con armi incendiarie...'",
            "Scarpa da bambino logora accanto a una piccola croce fatta di rametti e filo spinato.",
            "Graffito tracciato col sangue su un muro: 'Non fidatevi dell'acqua che brilla. NON BEVETELA.'",
            "Registrazione audio disturbata, voce maschile: '...stanno arrivando... le pareti non reggeranno... dite a mia figlia che l'amavo... il suo nome è Lily... *statica assordante*'",
            "Mappa disegnata a mano su un pezzo di pelle umana conciata: Indica un percorso verso un luogo chiamato \'L\'Oasi sotto le Stelle Cadute\', ma è strappata a metà.",
            "Messaggio inciso rozzamente su una capsula di proiettile 7.62: 'Per Mamma. Mi dispiace.'",
            "Libro bruciacchiato ('Miti Pre-Collasso') con una sola pagina leggibile: '...e così gli Antichi Dei dormirono nelle profondità della terra e del cielo, lasciando il mondo al silenzio e ai loro figli distorti...'",
            "Audio-log recuperato da un registratore militare: '...Soggetto 17 mostra rigenerazione cellulare accelerata... ma anche psicosi acuta... aggressività incontrollabile... perdita contenimento imminente... sterilizzare l'area...'",
            "Biglietto scritto a mano con grafia tremante: 'Se leggi questo, sono andato a cercare acqua al Vecchio Impianto Idrico. Non seguirmi, è pieno di Quei Cosi. Trova il Safe Place. Ti voglio bene. Papà.'",
            "Distintivo militare corroso dall'acido: Riporta il simbolo di un teschio alato e la scritta 'Guardiani della Volta - Unità Epurazione'.",
            "Terminale medico portatile, schermo rotto ma leggibile: Mostra una lettura parziale: 'Contaminazione Biologica Tipo Gamma - Necrosi Tessutale Rapida - Esposizione fatale entro 2 ore...'.",
            "Fotografia olografica incrinata e tremolante: Mostra una città vibrante e piena di luci volanti colorate, un'immagine quasi dolorosa da guardare ora.",
            "Bozza di messaggio non inviato, scritta su un tablet rotto: '...Eliza, non ce la faremo a raggiungerti. Le scorte bastano per uno solo. Prenditi cura di Ultimo... digli che la sua mamma era un'eroina... e che...'",
            "Schema tecnico strappato e macchiato: Descrive un 'Generatore Atmosferico Classe Arca' progettato per purificare l'aria su larga scala... mai attivato?",
            "Simbolo religioso improvvisato fatto di ossa umane, fili metallici e componenti elettronici.",
            "Ritaglio di giornale pre-guerra ('Il Cronista Globale'): Titolo: 'Nuova Era di Prosperità o Fuga dalla Realtà? Le Volte Salveranno l'Umanità o la Divideranno per Sempre?'",
            "Piccolo carillon arrugginito a forma di stella. Quando lo apri, suona una melodia triste e rivela uno scomparto segreto con dentro una chiave minuscola e ossidata.",
            "Appunto scarabocchiato su un tovagliolo unto: 'Segui il fiume morto verso il sole calante. Cerca la roccia che piange. Lì troverai la porta... se oserai bussare.'",
            "Chip dati incrinato e parzialmente fuso. Impossibile leggerlo senza l'attrezzatura di una Volta... o forse qualcosa di peggio.",
            "Manuale tecnico strappato ('Manutenzione Ripari Classe-C'): '...il sistema di filtraggio dell\'aria HEPA richiede sostituzione nucleo ogni 500 ore operative per evitare contaminazione interna...'",
            "Lista della spesa macchiata di sangue: 'Acqua (min. 5L), Munizioni (tutte!), Scatolette (proteine!), Nastro adesivo (molto!), Antidolorifici... Speranza (se ne trovi)...'",
            "Pagina di un bestiario improvvisato, scritto a mano con disegni disturbanti: Descrive una creatura notturna senza volto chiamata 'Il Sussurrante delle Ombre', che si nutre di ricordi."
        ];
        const radioMessages = [
            "...ripeto, Settore 7-G, evacuazione fallita... [STATICA]... bio-agente Omega... non avvicinatevi...",
            "...c'è qualcuno in ascolto? Rispondete, frequenza Delta-9... siamo intrappolati al [RUMORE BIANCO]... le scorte...",
            "...[CANZONE DEFORME e LENTA]... dove sei andato, mio dolce amore? Il mondo finisce stanotte...",
            "...numero 9... numero 9... numero 9... [CLICK] ...la trasmissione riprenderà...",
            "...Codice Scarlatto! Ripeto, Codice Scarlatto! La breccia è nel perimetro est! Cadono come mosche! [SPARO e URLA]...",
            "...[VOCE BAMBINA]... Mamma? Papà? C'è qualcuno lì fuori? Ho paura del buio...",
            "...Questo è un messaggio automatico del Sistema di Allerta Emergenza. Rimane [NUMERO DISTORTO] ore prima dell'impatto. Cercate riparo immediatamente... [SIRENA LONTANA]",
            "...[VOCE CALMA e SINISTRA]... Non siete soli là fuori. Vi osserviamo. Vi aspettiamo. Unitevi al Silenzio...",
            "...prova, uno, due... microfono funziona? Okay. Diario del Capitano, Giorno 83... la quarantena non regge. Le mutazioni... peggiorano... [STATICA INTENSA]",
            "...segnale di soccorso dalla Volta 12. Sistemi vitali al 5%. Richiediamo assistenza immediata... se c'è ancora qualcuno...",
            "...[MUSICA CLASSICA INTERROTTA]... annuncio di servizio: ricordate, 'Loro' ascoltano. Non usate nomi. Non parlate del passato...",
            "...ripeto, coordinate [NUMERI INCOMPRENSIBILI]... punto di estrazione Alfa tra 10 minuti. Ultima chiamata. Che Dio ci assista...",
            "...non credete alle loro bugie! Il 'Safe Place' è una trappola! È [SEGNALE INTERROTTO BRUSCAMENTE]",
            "...[SOSPIRO PROFONDO]... A chiunque trovi questo messaggio... Dite a mia moglie... ditele che ho provato...",
            "...[SEQUENZA NUMERICA RIPETUTA] ... 4 8 15 16 23 42 ... 4 8 15 16 23 42 ..."
        ];
        const descrizioniPredoni = ["Ombre furtive si muovono ai margini della tua vista...", "Figure emergono dalla polvere come spettri...", "Un fischio acuto e stridulo rompe il silenzio...", /* ...altri testi... */];
        const vociPredoni = ["'Fermi lì, bello! Non fare un passo di più.'", "'Cosa abbiamo qui? Carne fresca per il banchetto!'", /* ...altri testi... */];
        const esitiFugaPredoniOk = ["Scompari nell'ombra come fumo...", "Li distrai lanciando una pietra...", /* ...altri testi... */];
        const esitiFugaPredoniKo = ["Inciampi su un detrito nascosto...", "Esiti un attimo di troppo...", /* ...altri testi... */];
        const esitiLottaPredoniOk = ["Respingi il loro attacco scoordinato...", "Dopo un breve e brutale scontro...", /* ...altri testi... */];
        const esitiLottaPredoniKo = ["Vieni picchiato selvaggiamente...", "Ti derubano di quasi tutto...", /* ...altri testi... */];
        const esitiParlaPredoniOk = ["Sorprendentemente, le tue parole toccano una corda...", "Forse vedono in te un riflesso...", /* ...altri testi... */];
        const esitiParlaPredoniKo = ["'Belle parole, viaggiatore, ma la pancia è vuota...'", "Ridono sguaiatamente delle tue suppliche...", /* ...altri testi... */];
        const descrizioniAnimali = ["Un branco di cani selvatici...", "Un grosso cinghiale mutato...", /* ...altri testi... */];
        const esitiEvitaAnimaleOk = ["Riesci a sgattaiolare via silenziosamente...", "Passi con cautela estrema...", /* ...altri testi... */];
        const esitiEvitaAnimaleKo = ["Sei troppo lento o rumoroso!", "Sottovaluti i suoi sensi acuti...", /* ...altri testi... */];
        const esitiSpaventaAnimaleOk = ["Un urlo improvviso e disumano...", "Una pietra ben lanciata colpisce...", /* ...altri testi... */];
        const esitiSpaventaAnimaleKo = ["La bestia mutata si infuria ancora di più...", "Non sembra minimamente intimorito...", /* ...altri testi... */];
        const esitiAttaccoAnimaleOk = ["Con un colpo ben assestato...", "Riesci a ferirlo abbastanza...", /* ...altri testi... */];
        const esitiAttaccoAnimaleKo = ["Le sue zanne affilate o gli artigli penetrano...", "Vieni morso ferocemente...", /* ...altri testi... */];
        const descrizioniTracce = ["Noti delle impronte insolite...", "Qualcosa di grosso ha lasciato segni...", /* ...altri testi... */];
        const esitiSeguiTracceOkLoot = ["Le tracce ti portano a un piccolo nascondiglio...", "Seguendo le impronte trovi uno zaino...", /* ...altri testi... */];
        const esitiSeguiTracceOkLore = ["Le tracce ti conducono a un messaggio criptico...", "Trovi un diario logoro...", /* ...altri testi... */];
        const esitiSeguiTracceOkPredoni = ["Le tracce ti portano dritto in un'imboscata...", "Stavi seguendo dei predoni esperti...", /* ...altri testi... */];
        const esitiSeguiTracceOkNulla = ["Segui le tracce promettenti per un po'...", "Le impronte finiscono bruscamente...", /* ...altri testi... */];
        const esitiSeguiTracceKo = ["Non riesci a seguire le tracce confuse...", "Perdi il sentiero principale...", /* ...altri testi... */];
        const descrizioniVillaggioOstile = ["Dalle tende lacere emergono figure silenziose...", "Ti osservano immobili e in silenzio...", /* ...altri testi... */];
        const esitiVillaggioOstileAllontanati = ["Ti allontani lentamente...", "Fai dietrofront con cautela...", /* ...altri testi... */];
        const esitiVillaggioOstileNegoziaOk = ["Dopo una tesa e difficile conversazione...", "Riesci a convincerli...", /* ...altri testi... */];
        const esitiVillaggioOstileNegoziaKo = ["I tuoi tentativi di diplomazia falliscono...", "'Non vogliamo estranei qui!'", /* ...altri testi... */];
        const descrizioniPericoloAmbientaleAgilita = ["Il terreno friabile cede...", "Una vecchia trappola a scatto...", /* ...altri testi... */];
        const descrizioniPericoloAmbientalePresagio = ["Una pioggia di piccoli detriti cade...", "Senti uno scricchiolio sinistro...", /* ...altri testi... */];
        const esitiPericoloAmbientaleEvitato = ["Riesci a evitare il peggio per un soffio...", "Il tuo istinto di sopravvivenza ti salva...", /* ...altri testi... */];
        const esitiPericoloAmbientaleColpito = ["Non sei abbastanza veloce o attento!", "La trappola scatta...", /* ...altri testi... */];
        const descrizioniDilemmaMorale = ["Senti delle grida soffocate...", "Vedi del fumo nero alzarsi...", /* ...altri testi... */];
        const esitiDilemmaMoraleIndagaOkPositivo = ["Intervieni con coraggio...", "Segui il fumo e trovi...", /* ...altri testi... */];
        const esitiDilemmaMoraleIndagaOkNegativo = ["Arrivi troppo tardi...", "Le grida e il fumo erano una trappola...", /* ...altri testi... */];
        const esitiDilemmaMoraleIndagaKo = ["Cerchi di intervenire ma sottovaluti...", "Non riesci a trovare la fonte...", /* ...altri testi... */];
        const esitiDilemmaMoraleIgnora = ["Decidi freddamente che non sono affari tuoi...", "La tua sopravvivenza viene prima...", /* ...altri testi... */];
        const descrizioniRifugioStrano = ["Mentre cerchi di riposare, noti una sezione...", "C'è un piccolo contenitore metallico...", /* ...altri testi... */];
        const esitiRifugioIspezionaOkLoot = ["Rimuovendo con cautela la sezione...", "Il pesante contenitore metallico...", /* ...altri testi... */];
        const esitiRifugioIspezionaOkLore = ["Il simbolo inciso sul pavimento...", "Trovi un messaggio logoro...", /* ...altri testi... */];
        const esitiRifugioIspezionaKoTrappola = ["Era una trappola!", "Il contenitore era protetto...", /* ...altri testi... */];
        const esitiRifugioIspezionaKoNulla = ["È solo una strana macchia...", "Il contenitore metallico è completamente vuoto...", /* ...altri testi... */];
        const esitiRifugioLasciaPerdere = ["Meglio non rischiare per nulla...", "La curiosità ha ucciso il gatto...", /* ...altri testi... */];
        const descrizioniPredoniNotturni = ["Figure silenziose emergono dall'oscurità...", "Approfittano della copertura del buio...", /* ...altri testi... */];
        const descrizioniAnimaleNotturno = ["Due occhi rossi e luminosi ti fissano...", "Un ringhio basso e gutturale...", /* ...altri testi... */];
        const descrizioniPericoloAmbientaleNotturno = ["Inciampi violentemente in qualcosa...", "Il terreno, già instabile di giorno...", /* ...altri testi... */];
        const descrizioniOrroreIndicibile = ["Un senso di oppressione innaturale...", "Senti distintamente una presenza...", /* ...altri testi... */];
        const esitiOrroreIndicibileFugaOk = ["Scappi a gambe levate urlando...", "Ti nascondi tremando...", /* ...altri testi... */];
        const esitiOrroreIndicibileFugaKo = ["La paura assoluta ti paralizza...", "Non riesci a sfuggire...", /* ...altri testi... */];
        const esitiOrroreIndicibileAffrontaOk = ["Stringi i denti e resisti...", "Urli la tua sfida rabbiosa...", /* ...altri testi... */];
        const esitiOrroreIndicibileAffrontaKo = ["Il tuo coraggio, per quanto grande, vacilla...", "Vieni sopraffatto da visioni...", /* ...altri testi... */];
        // (Nota: Ho abbreviato le liste qui per brevità, ma nel codice completo sono presenti)


        // --- Variabili di Stato ---
        let player = {};
        let map = [];
        let messages = [];
        let gameActive = false;
        let eventScreenActive = false;
        let currentEventChoices = [];
        let currentEventContext = null;
        let dayMovesCounter = 0; // Contatore passi diurni
        let isDay = true;       // Flag Giorno/Notte
        let daysSurvived = 0;   // Contatore giorni completati

        // --- Riferimenti DOM (Definiti subito) ---
        const gameContainer = document.getElementById('game-container');
        const endScreen = document.getElementById('end-screen');
        const endTitle = document.getElementById('end-title');
        const endMessage = document.getElementById('end-message');
        const mapDisplay = document.getElementById('map-display');
        const statsList = document.getElementById('stats-list');
        const statHp = document.getElementById('stat-hp');
        const statMaxHp = document.getElementById('stat-maxhp');
        const statVig = document.getElementById('stat-vig');
        const statPot = document.getElementById('stat-pot');
        const statAgi = document.getElementById('stat-agi');
        const statTra = document.getElementById('stat-tra');
        const statInf = document.getElementById('stat-inf');
        const statPre = document.getElementById('stat-pre');
        const statAda = document.getElementById('stat-ada');
        const statAcq = document.getElementById('stat-acq');
        const statFood = document.getElementById('stat-food');
        const statWater = document.getElementById('stat-water');
        const posX = document.getElementById('pos-x');
        const posY = document.getElementById('pos-y');
        const tileType = document.getElementById('tile-type');
        const statDayTime = document.getElementById('stat-day-time');
        const messagesList = document.getElementById('messages');
        const moveButtons = document.querySelectorAll('#controls button');
        const eventOverlay = document.getElementById('event-overlay');
        const eventTitle = document.getElementById('event-title');
        const eventContent = document.getElementById('event-content');
        const legendList = document.getElementById('legend-list');
        const continueButton = eventOverlay.querySelector('.continue-button');

        // --- FUNZIONI UTILITY ---
        function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function getRandomText(arr) { if (!arr || arr.length === 0) return ""; return arr[getRandomInt(0, arr.length - 1)]; }
        function addMessage(msg, type = 'info', emphasize = false) {
             if(typeof msg !== 'string') msg = String(msg);
             const maxLogMsgLength = 70;
             let displayMsg = msg.length > maxLogMsgLength ? msg.substring(0, maxLogMsgLength) + '...' : msg;
             messages.unshift(`${emphasize ? '<span class="log-warning">' : ''}> ${displayMsg}${emphasize ? '</span>' : ''}`);
             if (messages.length > MAX_MESSAGES) { messages.pop(); }
             renderMessages();
         }

        // --- FUNZIONI DI GIOCO ---

        function initializeGame() {
            // Pulisce stato precedente
            messages = [];
            player = {};
            map = [];
            gameActive = false;
            eventScreenActive = false;
            dayMovesCounter = 0;
            isDay = true;
            daysSurvived = 0;

            try {
                generateCharacter();
                if (!player || typeof player.vigore !== 'number') throw new Error("Generazione Personaggio Fallita");
                generateMap();
                if (!map || map.length === 0 || typeof player.x !== 'number') throw new Error("Generazione Mappa/Posizione Fallita");
            } catch(e) {
                console.error("ERRORE INIZIALIZZAZIONE:", e);
                if(mapDisplay) mapDisplay.textContent = `ERRORE INIZIALIZZAZIONE: ${e.message}`;
                return; // Ferma se l'inizializzazione fallisce
            }

            gameActive = true;
            eventOverlay.style.display = 'none';
            endScreen.style.display = 'none';
            gameContainer.style.display = 'flex'; // Mostra l'interfaccia di gioco

            try {
                renderLegend();
                renderStats();
                renderMap();
                renderMessages(); // Pulisce log precedente se c'era
                addMessage(`Inizio viaggio. HP:${player.hp}, Cibo:${player.food}, Acqua:${player.water}. È Giorno.`);
            } catch (e) {
                console.error("ERRORE RENDER INIZIALE:", e);
                if(mapDisplay) mapDisplay.textContent = "Errore nel rendering iniziale!";
                gameActive = false; // Impedisce di giocare se il rendering fallisce
            }

            if (gameActive) {
                enableControls();
                setupInputListeners();
            }
        }

        function generateCharacter() {
            player = {
                name: "Ultimo",
                vigore: 9 + getRandomInt(0, 2),
                potenza: 9 + getRandomInt(0, 2),
                agilita: 14 + getRandomInt(0, 2),
                tracce: 14 + getRandomInt(0, 2),
                influenza: 6 + getRandomInt(0, 2),
                presagio: 7 + getRandomInt(0, 2),
                adattamento: 9 + getRandomInt(0, 2),
                acquisita: 8 + getRandomInt(0, 2),
                maxHp: 0, hp: 0, x: undefined, y: undefined,
                food: STARTING_FOOD, water: STARTING_WATER,
                ammo: 0, // Non usata al momento?
                movesCounter: 0 // Non usata al momento?
            };
            player.maxHp = 10 + player.vigore;
            player.hp = player.maxHp;
        }

        function generateMap() {
            map = [];
            let startPos = null;
            // Genera mappa base
            for (let y = 0; y < MAP_HEIGHT; y++) {
                map[y] = [];
                for (let x = 0; x < MAP_WIDTH; x++) {
                    let tileType = TILE_SYMBOLS.PLAINS;
                    const rand = Math.random();
                    if (rand < 0.10) tileType = TILE_SYMBOLS.MOUNTAIN;
                    else if (rand < 0.20) tileType = TILE_SYMBOLS.FOREST;
                    else if (rand < 0.26) tileType = TILE_SYMBOLS.RIVER;
                    else if (rand < 0.30) tileType = TILE_SYMBOLS.VILLAGE;
                    else if (rand < 0.32) tileType = TILE_SYMBOLS.CITY;
                    else if (rand < 0.35) tileType = TILE_SYMBOLS.REST_STOP;
                    map[y][x] = { type: tileType, visited: false };
                }
            }
            // Posiziona Start ('S')
            let startX, startY, attempts = 0;
            do {
                startX = getRandomInt(1, Math.floor(MAP_WIDTH / 4));
                startY = getRandomInt(1, Math.floor(MAP_HEIGHT / 4));
                attempts++;
            } while ((!map[startY]?.[startX] || map[startY][startX].type !== TILE_SYMBOLS.PLAINS) && attempts < 100);
            if (attempts >= 100) { startX = 1; startY = 1; } // Fallback
            map[startY][startX] = { type: TILE_SYMBOLS.START, visited: true };
            startPos = { x: startX, y: startY };

            // Posiziona End ('E')
            let endX, endY;
            attempts = 0;
            do {
                endX = getRandomInt(Math.floor(MAP_WIDTH * 3 / 4), MAP_WIDTH - 2);
                endY = getRandomInt(Math.floor(MAP_HEIGHT * 3 / 4), MAP_HEIGHT - 2);
                attempts++;
                if (attempts > 100) { endX = MAP_WIDTH - 2; endY = MAP_HEIGHT - 2; break; } // Fallback
            } while (!map[endY]?.[endX] || map[endY][endX].type === TILE_SYMBOLS.MOUNTAIN || map[endY][endX].type === TILE_SYMBOLS.RIVER || (endX === startX && endY === startY));

            if (map[endY]?.[endX]) {
                map[endY][endX] = { type: TILE_SYMBOLS.END, visited: false };
            } else { // Fallback estremo se le coordinate generate non sono valide
                 map[MAP_HEIGHT - 2][MAP_WIDTH - 2] = { type: TILE_SYMBOLS.END, visited: false };
            }

            player.x = startPos.x;
            player.y = startPos.y;
        }

        function renderStats() {
            try {
                statHp.textContent = player?.hp ?? '--'; statMaxHp.textContent = player?.maxHp ?? '--';
                statVig.textContent = player?.vigore ?? '--'; statPot.textContent = player?.potenza ?? '--';
                statAgi.textContent = player?.agilita ?? '--'; statTra.textContent = player?.tracce ?? '--';
                statInf.textContent = player?.influenza ?? '--'; statPre.textContent = player?.presagio ?? '--';
                statAda.textContent = player?.adattamento ?? '--'; statAcq.textContent = player?.acquisita ?? '--';
                statFood.textContent = player?.food ?? '--'; statWater.textContent = player?.water ?? '--';
                statFood.classList.toggle('low-resource', (player?.food ?? 99) <= 1);
                statWater.classList.toggle('low-resource', (player?.water ?? 99) <= 1);
                posX.textContent = player?.x ?? '--'; posY.textContent = player?.y ?? '--';

                if (gameActive && map?.[player?.y]?.[player?.x]) {
                    const currentTile = map[player.y][player.x];
                    tileType.textContent = TILE_DESC[currentTile.type] || '???';
                } else if (gameActive) {
                    tileType.textContent = 'Inizio...';
                } else {
                    tileType.textContent = '--';
                }

                if (statDayTime) {
                    if (isDay) {
                        statDayTime.textContent = `${DAY_LENGTH_MOVES - dayMovesCounter} p.`;
                    } else {
                        statDayTime.textContent = 'Notte';
                    }
                }
            } catch (e) {
                console.error("Errore rendering statistiche:", e);
                if (tileType) tileType.textContent = 'ERR STATS';
            }
        }

        function renderMessages() {
            try { messagesList.innerHTML = messages.map(msg => `<li>${msg}</li>`).join(''); }
            catch (e) { console.error("Errore rendering messaggi:", e); }
        }

        function renderLegend() {
            try {
                legendList.innerHTML = '';
                const legendItems = [
                    { s: TILE_SYMBOLS.PLAYER, d: TILE_DESC['@'] }, { s: TILE_SYMBOLS.PLAINS, d: TILE_DESC['.'] },
                    { s: TILE_SYMBOLS.FOREST, d: TILE_DESC['F'] }, { s: TILE_SYMBOLS.MOUNTAIN, d: TILE_DESC['M'] },
                    { s: TILE_SYMBOLS.RIVER, d: TILE_DESC['~'] }, { s: TILE_SYMBOLS.VILLAGE, d: TILE_DESC['V'] },
                    { s: TILE_SYMBOLS.CITY, d: TILE_DESC['C'] }, { s: TILE_SYMBOLS.REST_STOP, d: TILE_DESC['R'] },
                    { s: TILE_SYMBOLS.START, d: TILE_DESC['S'] }, { s: TILE_SYMBOLS.END, d: TILE_DESC['E'] }
                ];
                legendItems.forEach(item => {
                    const tileKey = Object.keys(TILE_SYMBOLS).find(k => TILE_SYMBOLS[k] === item.s);
                    const tileClass = `tile-${tileKey ? tileKey.toLowerCase().replace(/_/g, '-') : 'unk'}`;
                    const endClass = item.s === TILE_SYMBOLS.END ? 'tile-end' : '';
                    legendList.innerHTML += `<li><span class="legend-symbol ${tileClass} ${endClass}">${item.s}</span> = ${item.d}</li>`;
                });
            } catch (e) { console.error("Errore rendering legenda:", e); }
        }

        function renderMap() {
            const display = mapDisplay; if (!display) return;
            if (!player || typeof player.x !== 'number') { display.textContent = "ERRORE: Player non valido"; return; }
            if (!map || !map.length) { display.textContent = "ERRORE: Mappa non valida"; return; }

            player.x = Math.max(0, Math.min(MAP_WIDTH - 1, player.x));
            player.y = Math.max(0, Math.min(MAP_HEIGHT - 1, player.y));

            let mapString = "";
            const viewWidth = 40, viewHeight = 25; // Dimensioni viewport mappa
            const halfWidth = Math.floor(viewWidth / 2);
            const halfHeight = Math.floor(viewHeight / 2);

            // Calcola coordinate start viewport, centrate sul giocatore ma limitate dai bordi mappa
            let startX = Math.max(0, player.x - halfWidth);
            let startY = Math.max(0, player.y - halfHeight);
            startX = Math.min(startX, MAP_WIDTH - viewWidth);
            startY = Math.min(startY, MAP_HEIGHT - viewHeight);
            startX = Math.max(0, startX); // Assicura non sia < 0 dopo la correzione
            startY = Math.max(0, startY); // Assicura non sia < 0 dopo la correzione

            let endX = Math.min(MAP_WIDTH, startX + viewWidth);
            let endY = Math.min(MAP_HEIGHT, startY + viewHeight);

            try {
                for (let y = startY; y < endY; y++) {
                    if (y < 0 || y >= map.length) continue; // Sicurezza extra
                    for (let x = startX; x < endX; x++) {
                        if (x < 0 || !map[y] || x >= map[y].length) continue; // Sicurezza extra

                        if (x === player.x && y === player.y) {
                            mapString += `<span class="player-marker">${TILE_SYMBOLS.PLAYER}</span>`;
                        } else {
                            const tile = map[y][x];
                            const symbol = tile?.type || '?';
                            const tileKey = Object.keys(TILE_SYMBOLS).find(k => TILE_SYMBOLS[k] === symbol);
                            let tileClass = `tile-${tileKey ? tileKey.toLowerCase().replace(/_/g, '-') : 'unk'}`;
                            let visitedClass = tile?.visited ? 'visited' : '';
                            let endClass = symbol === TILE_SYMBOLS.END ? 'tile-end' : '';
                            mapString += `<span class="${tileClass} ${visitedClass} ${endClass}">${symbol}</span>`;
                        }
                    }
                    mapString += "\n"; // Nuova riga alla fine di ogni riga della mappa
                }
            } catch (e) {
                console.error("Errore loop rendering mappa:", e);
                display.textContent = "Errore Rendering Mappa!";
                return;
            }
            display.innerHTML = mapString; // Usa innerHTML per interpretare gli span
        }

        function disableControls(disabled = true) { moveButtons.forEach(btn => btn.disabled = disabled); }
        function enableControls() { if (gameActive) moveButtons.forEach(btn => btn.disabled = false); }

        function performSkillCheck(statKey, difficulty) {
            const statValue = player[statKey] || 5; // Default a 5 se stat non trovata
            const roll = getRandomInt(1, 20);
            const bonus = Math.floor((statValue - 10) / 2); // Modificatore D&D style
            const total = roll + bonus;
            const success = total >= difficulty;
            const resultText = `Prova ${statKey.toUpperCase()}(Diff ${difficulty}): D20(${roll}) + Mod(${bonus}) = ${total} -> ${success ? "SUCCESSO!" : '<span class="danger-text">FALLIMENTO!</span>'}`;
            return { success: success, text: resultText };
        }

        function showEventPopup(title, content, choices = [], checkResult = null, consequenceText = "") {
            if (!gameActive && !(title.includes("Fine") || title.includes("Destinazione"))) return; // Permette popup fine gioco

            eventTitle.textContent = title;
            let fullHTML = content.replace(/\n/g, '<br>'); // Gestisce newline nel testo

            if (checkResult) {
                fullHTML += `<br><br>${checkResult.text}`; // Mostra risultato check
            }
            if (consequenceText) {
                 // Aggiunge nuova riga solo se c'è già testo risultato check, altrimenti usa la prima
                fullHTML += `${checkResult ? '<br>' : '<br><br>'}${consequenceText.replace(/\n/g, '<br>')}`;
            }

            let choiceHTML = "";
            if (choices?.length > 0) {
                currentEventChoices = choices; // Salva scelte per input tastiera
                choices.forEach(choice => {
                    choiceHTML += `<div class="event-choice"><button onclick="handleEventChoice('${choice.key}')">${choice.text}</button></div>`;
                });
                continueButton.classList.add('hidden'); // Nasconde "Continua" se ci sono scelte
            } else {
                currentEventChoices = []; // Nessuna scelta
                currentEventContext = null; // Resetta contesto
                continueButton.classList.remove('hidden'); // Mostra "Continua"
            }

            eventContent.innerHTML = fullHTML + choiceHTML; // Inserisce contenuto e pulsanti
            eventOverlay.style.display = 'block';
            disableControls(true); // Disabilita controlli mappa
            eventScreenActive = true;
            eventContent.scrollTop = 0; // Scrolla all'inizio
        }

        function hideEventScreen() {
            if (!eventScreenActive) return;
            eventOverlay.style.display = 'none';
            eventScreenActive = false;
            currentEventChoices = [];
            currentEventContext = null;
            if (gameActive) enableControls(); // Riabilita controlli mappa se il gioco è attivo
        }

        function showEndGameMessage(isVictory) {
            gameActive = false;
            disableControls(true);
            eventOverlay.style.display = 'none';
            gameContainer.style.display = 'none';

            if (isVictory) {
                endTitle.textContent = "Destinazione Raggiunta...";
                endMessage.innerHTML = `...Sei arrivato. Davanti a te, una vecchia porta blindata semi-sepolta, con uno strano simbolo inciso... Il simbolo di tuo padre... L\'aria all\'interno è viziata... Un terminale spento è incassato nella parete... È questo il \'Safe Place\'? ...Il tuo viaggio per ora termina qui, Ultimo. Ma la storia... sembra appena iniziata. (Fine del Prototipo - Capitolo 1)`.replace(/\n/g, '<br>');
            } else {
                endTitle.textContent = "Il Viaggio Termina Qui";
                endMessage.textContent = "Le ferite, la fame, la disperazione... Questo mondo non perdona. Sei caduto, Ultimo. Le rovine reclamano un\'altra vita. La ricerca del Safe Place finisce nell\'oblio.";
            }
            endScreen.style.display = 'flex';
        }

        function handleTileEvent(tile) {
            if (!tile || !gameActive) return false;
            tile.visited = true;
            const tileSymbol = tile.type;
            let popupShown = false;
            let statsChanged = false;
            let penaltyApplied = false;

            addMessage(`Entri: ${TILE_DESC[tileSymbol] || '???'}${(isDay ? '' : ' (Notte)')}`);

            // Probabilità base e pool eventi (giorno)
            let baseEventChance = 0;
            let allowedEventsOnTile = [];
            switch(tileSymbol) {
                case TILE_SYMBOLS.PLAINS: baseEventChance = 0.15; allowedEventsOnTile = ['animale', 'loot_semplice', 'lore', 'tracce_strane', 'eco_radio']; break;
                case TILE_SYMBOLS.FOREST: baseEventChance = 0.30; allowedEventsOnTile = ['animale', 'tracce_strane', 'pericolo_ambientale', 'lore', 'dilemma_morale', 'ritrovamento_dubbio']; break;
                case TILE_SYMBOLS.MOUNTAIN: baseEventChance = 0.20; allowedEventsOnTile = ['animale', 'pericolo_ambientale', 'lore', 'tracce_strane']; break;
                case TILE_SYMBOLS.RIVER: baseEventChance = 0.10; allowedEventsOnTile = ['loot_semplice']; break;
                case TILE_SYMBOLS.CITY: baseEventChance = 0.65; allowedEventsOnTile = ['predoni', 'animale', 'tracce_strane', 'loot_semplice', 'lore', 'pericolo_ambientale', 'dilemma_morale', 'eco_radio', 'ritrovamento_dubbio']; break;
                case TILE_SYMBOLS.VILLAGE: baseEventChance = 0.50; allowedEventsOnTile = ['villaggio_ostile', 'loot_semplice', 'lore', 'tracce_strane', 'dilemma_morale']; break;
            }

            // Modifiche per la notte
            if (!isDay) {
                baseEventChance *= 1.8; // Aumenta probabilità di notte
                const nightEventPool = ['predoni', 'animale_notturno', 'pericolo_ambientale_notturno', 'orrore_indicibile', 'tracce_strane'];
                // Filtra gli eventi possibili di notte basandosi su quelli permessi sulla tile
                const possibleNightEvents = allowedEventsOnTile.filter(type => nightEventPool.includes(type));
                if (possibleNightEvents.length > 0) {
                    allowedEventsOnTile = possibleNightEvents;
                } else {
                    // Se la tile non ha eventi notturni specifici, usa il pool generico notturno con bassa probabilità
                     if (Math.random() < 0.1) { // Bassa chance di evento generico notturno
                        allowedEventsOnTile = nightEventPool;
                    } else {
                        baseEventChance = 0; // Nessun evento casuale se non specifici per la notte
                    }
                }
                if (allowedEventsOnTile.length === 0) baseEventChance = 0;
            }

            // Controlla evento casuale sulla tile (se non Start, End, Rest Stop)
            if (tileSymbol !== TILE_SYMBOLS.START && tileSymbol !== TILE_SYMBOLS.END && tileSymbol !== TILE_SYMBOLS.REST_STOP && baseEventChance > 0 && Math.random() < baseEventChance) {
                triggerRandomEvent(allowedEventsOnTile);
                return true; // Evento casuale ha mostrato un popup
            }

            // Logica eventi specifici per tile / Flavor text
            let specificEventTitle = "", specificEventDesc = "", specificEventChoices = [], specificEventCheck = null, specificEventCons = "", immediateEvent = false;
            let flavor = "";

            switch (tileSymbol) {
                case TILE_SYMBOLS.REST_STOP:
                    if (!isDay) { // Notte: Riposo forzato
                        specificEventTitle = "Rifugio Trovato (Notte)";
                        specificEventDesc = "Sei riuscito a trovare un rifugio appena in tempo! Puoi finalmente riposare fino all'alba.";
                        immediateEvent = true;

                        isDay = true;
                        dayMovesCounter = 0;
                        daysSurvived++;
                        addMessage(`[FASE] Hai passato la notte al sicuro. Sorge un nuovo Giorno (Giorno ${daysSurvived + 1}).`, 'info', true);

                        player.food = Math.max(0, player.food - NIGHT_FOOD_COST);
                        player.water = Math.max(0, player.water - NIGHT_WATER_COST);
                        addMessage(`[CONSUMO] Il riposo ha richiesto energie (-${NIGHT_FOOD_COST} Cibo, -${NIGHT_WATER_COST} Acqua).`, 'info');
                        statsChanged = true;

                        if (player.food === 0) {
                            player.hp = Math.max(0, player.hp - HUNGER_PENALTY_HP);
                            addMessage(`[ATTENZIONE] Fame! Hai passato la notte senza cibo (-${HUNGER_PENALTY_HP} HP)`, 'info', true);
                            penaltyApplied = true;
                        }
                        if (player.water === 0) {
                            player.hp = Math.max(0, player.hp - THIRST_PENALTY_HP);
                            addMessage(`[ATTENZIONE] Sete! Hai passato la notte senz'acqua (-${THIRST_PENALTY_HP} HP)`, 'info', true);
                            penaltyApplied = true;
                        }

                        if (player.hp < player.maxHp && !penaltyApplied) {
                            const recoveredHp = getRandomInt(1, 2);
                            player.hp = Math.min(player.maxHp, player.hp + recoveredHp);
                            specificEventCons = `Riprendi un po' di fiato (+${recoveredHp} HP).`;
                            statsChanged = true;
                        } else if (penaltyApplied) {
                            specificEventCons = "Sei esausto e affamato/assetato, il riposo non basta.";
                        } else {
                            specificEventCons = "Passi la notte relativamente tranquillo.";
                        }
                        specificEventChoices = [];

                    } else { // Giorno: Possibilità di ispezionare
                        flavor = getRandomText(flavorTextsRestStop);
                        specificEventTitle = "Rifugio Esplorato (Giorno)";
                        specificEventDesc = `${flavor ? flavor + '\n\n' : ''}Trovi un rifugio. Potrebbe essere utile fermarsi più tardi.\n${getRandomText(descrizioniRifugioStrano)}\nCosa fai?`;
                        immediateEvent = true;
                        specificEventChoices = [
                            { key: 'I', text: "Ispeziona (Tracce)" },
                            { key: 'L', text: "Lascia perdere" }
                        ];
                        currentEventContext = { event: 'rifugio_scelta', difficulty: 11 };
                    }
                    break;

                case TILE_SYMBOLS.END:
                    if (gameActive) showEndGameMessage(true);
                    return false; // Nessun popup evento qui, gestito da showEndGameMessage

                // Aggiungi flavor text per altre caselle se non c'è stato evento casuale
                case TILE_SYMBOLS.PLAINS: flavor = getRandomText(isDay ? flavorTextsPlains : flavorTextsNightPlains); break;
                case TILE_SYMBOLS.FOREST: flavor = getRandomText(isDay ? flavorTextsForest : flavorTextsNightForest); break;
                case TILE_SYMBOLS.MOUNTAIN: flavor = getRandomText(flavorTextsMountain); break;
                case TILE_SYMBOLS.RIVER: flavor = getRandomText(flavorTextsRiver); break;
                case TILE_SYMBOLS.CITY: flavor = getRandomText(flavorTextsCity); break;
                case TILE_SYMBOLS.VILLAGE: flavor = getRandomText(flavorTextsVillage); break;
            }

            if (flavor && !immediateEvent) { // Mostra flavor solo se non c'è già un evento specifico immediato
                addMessage(flavor);
            }

            // Gestione statistiche e game over dopo eventi specifici (es. riposo notturno)
            if (statsChanged) {
                 renderStats();
                 if (checkGameOver()) return true; // Esce se game over
             }

            // Mostra popup evento specifico se necessario
            if (immediateEvent && !eventScreenActive) {
                 showEventPopup(specificEventTitle, specificEventDesc, specificEventChoices, specificEventCheck, specificEventCons);
                 return true; // Popup mostrato
            }

            return false; // Nessun popup mostrato da questa funzione
        }

        function triggerRandomEvent(allowedTypes = []) {
            if (!gameActive || eventScreenActive || allowedTypes.length === 0) return;

            let eventType = "";
            let difficultyModifier = 0; // Modificatore difficoltà base (es. per notte)
            let baseDifficulty = 12;    // Difficoltà base generica

            // Filtra eventi permessi e applica modificatore notte
            let possibleEvents = [];
            if (!isDay) { // NOTTE
                const nightPool = ['predoni', 'animale_notturno', 'pericolo_ambientale_notturno', 'orrore_indicibile', 'tracce_strane'];
                possibleEvents = allowedTypes.filter(type => nightPool.includes(type));
                if (possibleEvents.length === 0) { // Fallback se tile non ha eventi notturni specifici
                    possibleEvents = nightPool.filter(type => allowedTypes.includes(type)); // Cerca nel pool generale notturno
                    if (possibleEvents.length === 0) return; // Nessun evento notturno possibile
                }
                difficultyModifier = getRandomInt(1, 3); // Notte rende più difficile
            } else { // GIORNO
                 const dayPool = ['predoni', 'animale', 'tracce_strane', 'loot_semplice', 'lore', 'pericolo_ambientale', 'dilemma_morale', 'villaggio_ostile', 'eco_radio', 'ritrovamento_dubbio'];
                 possibleEvents = allowedTypes.filter(type => dayPool.includes(type));
                 if (possibleEvents.length === 0) return; // Nessun evento diurno possibile
            }

            eventType = getRandomText(possibleEvents);

             // Log evento scelto (esclusi loot e lore che loggano dopo l'esito)
            if (eventType !== 'loot_semplice' && eventType !== 'lore') {
                addMessage(`[EVENTO] ${isDay ? '' : '[NOTTE] '}${eventType.replace(/_/g, ' ')}!`, 'info', true);
            }

            let title = "Evento Inaspettato", desc = "", choices = [], check = null, cons = "";
            let statsChanged = false;
            currentEventContext = { event: eventType, difficultyMod: difficultyModifier }; // Imposta contesto base

            // Definisci difficoltà specifiche per evento
            switch (eventType) {
                 case 'predoni': baseDifficulty = 12; break;
                 case 'animale': baseDifficulty = 11; break;
                 case 'animale_notturno': baseDifficulty = 13; break;
                 case 'tracce_strane': baseDifficulty = 13; break;
                 case 'villaggio_ostile': baseDifficulty = 14; break;
                 case 'pericolo_ambientale': baseDifficulty = 12; break; // Sarà sovrascritto dal sottotipo
                 case 'pericolo_ambientale_notturno': baseDifficulty = 13; break; // Sarà sovrascritto dal sottotipo
                 case 'dilemma_morale': baseDifficulty = 12; break;
                 case 'orrore_indicibile': baseDifficulty = 15; break;
                 case 'eco_radio': baseDifficulty = 13; break;
                 case 'ritrovamento_dubbio': baseDifficulty = 12; break;
                 // loot e lore non hanno difficoltà
                 default: baseDifficulty = 12; break;
            }
             currentEventContext.difficulty = baseDifficulty; // Salva difficoltà base nel contesto

            // Logica specifica per tipo di evento
            switch (eventType) {
                case 'predoni':
                    title = isDay ? "Predoni!" : "Imboscata Notturna!";
                    desc = `${getRandomText(isDay ? descrizioniPredoni : descrizioniPredoniNotturni)}\n${getRandomText(vociPredoni)}`;
                    choices = [{ key: 'F', text: "Fuggi (Agilità)" },{ key: 'C', text: "Combatti (Potenza)" },{ key: 'P', text: "Parla (Influenza)" }];
                    break;
                case 'animale':
                    title = "Animale Selvatico!";
                    desc = `Un ${getRandomText(descrizioniAnimali)} ti sbarra il passo, ringhiando.`;
                    choices = [{ key: 'E', text: "Evita (Agilità/Tracce)" },{ key: 'S', text: "Spaventa (Influenza)" },{ key: 'A', text: "Attacca (Potenza)" }];
                    break;
                case 'animale_notturno':
                    title = "Bestia Notturna!";
                    desc = getRandomText(descrizioniAnimaleNotturno);
                    choices = [ { key: 'E', text: "Evita furtivamente (Agilità)" }, { key: 'A', text: "Attacca nell'ombra (Potenza)" }, { key: 'O', text: "Osserva da lontano (Tracce)" }];
                    break;
                case 'tracce_strane':
                    title = "Tracce Strane"; desc = getRandomText(descrizioniTracce);
                    choices = [{ key: 'I', text: "Ignora" },{ key: 'S', text: "Segui (Tracce)" }];
                    break;
                case 'villaggio_ostile':
                    title = "Accampamento Ostile"; desc = getRandomText(descrizioniVillaggioOstile);
                    choices = [{ key: 'A', text: "Allontanati" },{ key: 'N', text: "Negozia (Influenza)" }];
                    break;
                case 'loot_semplice':
                    title = "Oggetti Abbandonati";
                    const lootType = Math.random() < 0.6 ? 'Cibo' : 'Acqua';
                    const amount = getRandomInt(1, 3);
                    desc = `Frugando tra i detriti, trovi ${amount} unità di ${lootType}.`;
                    if (lootType === 'Cibo') player.food += amount; else player.water += amount;
                    statsChanged = true; choices = []; cons = ""; // Nessuna scelta, conseguenza diretta
                    addMessage(`Hai trovato ${amount} ${lootType}.`, 'info');
                    break;
                case 'lore':
                    title = "Eco dal Passato";
                    desc = `Trovi un frammento di conoscenza perduta:\n"${getRandomText(loreFragments)}"`;
                    addMessage("Hai trovato un frammento di lore.", 'info'); choices = []; cons = "";
                    break;
                case 'pericolo_ambientale':
                    title = "Pericolo Improvviso!";
                    if (Math.random() < 0.5) {
                         desc = getRandomText(descrizioniPericoloAmbientaleAgilita); choices = [ { key: 'S', text: "Schiva (Agilità)" } ];
                         currentEventContext.subType = 'agilita_check'; currentEventContext.difficulty = 12; currentEventContext.damage = getRandomInt(1, 2);
                    } else {
                        desc = getRandomText(descrizioniPericoloAmbientalePresagio); choices = [ { key: 'R', text: "Reagisci (Presagio)" } ];
                        currentEventContext.subType = 'presagio_check'; currentEventContext.difficulty = 13; currentEventContext.damage = getRandomInt(1, 3);
                    }
                    break;
                case 'pericolo_ambientale_notturno':
                     title = "Pericolo nell'Ombra!";
                     desc = getRandomText(descrizioniPericoloAmbientaleNotturno);
                     if (Math.random() < 0.5) {
                         choices = [ { key: 'S', text: "Balza via (Agilità)" } ];
                         currentEventContext.subType = 'agilita_check'; currentEventContext.difficulty = 13; currentEventContext.damage = getRandomInt(1, 3);
                     } else {
                         choices = [ { key: 'P', text: "Percepisci (Presagio)" } ];
                         currentEventContext.subType = 'presagio_check'; currentEventContext.difficulty = 14; currentEventContext.damage = getRandomInt(2, 3);
                     }
                     break;
                case 'dilemma_morale':
                     title = "Dilemma Morale"; desc = getRandomText(descrizioniDilemmaMorale);
                     choices = [{ key: 'I', text: "Indaga / Intervieni (Rischioso)" },{ key: 'N', text: "Non è affar mio / Ignora" }];
                     break;
                case 'orrore_indicibile':
                     title = "Orrore Indicibile"; desc = getRandomText(descrizioniOrroreIndicibile);
                     choices = [ { key: 'F', text: "Fuggi disperatamente (Agilità)" }, { key: 'A', text: "Affronta l'ignoto (Vigore)" }];
                     currentEventContext.sanityDamage = getRandomInt(1, 2);
                     break;
                 case 'eco_radio':
                     title = getRandomText(["Eco Radio Debole", "Segnale Intermittente", "Voce nella Statica"]);
                     desc = getRandomText(["Senti un debole crepitio radio.", "Una vecchia radio emette strani suoni.", "Un frammento di voce metallica..."]);
                     check = performSkillCheck('adattamento', currentEventContext.difficulty + currentEventContext.difficultyMod); // Applica mod notte qui
                     if (check.success) { cons = `Riesci a sentire:\n'${getRandomText(radioMessages)}'`; }
                     else { cons = getRandomText(["Solo statica.", "Troppo danneggiato.", "Segnale perso."]); }
                     choices = []; // Nessuna scelta, solo risultato
                     break;
                case 'ritrovamento_dubbio':
                    title = getRandomText(["Ritrovamento Dubbio", "Offerta Inaspettata?"]);
                    desc = getRandomText(["Trovi un fagotto avvolto con cura.", "Una borraccia quasi nuova è appesa a un ramo.", "Vedi una figura scomparire, lasciando cadere qualcosa."]);
                    desc += "\n\nSembra troppo bello per essere vero. Cosa fai?";
                    choices = [ { key: 'P', text: "Prendi la Scorta (Rischioso)" }, { key: 'L', text: "Lascia perdere (Sicuro)" }];
                    break;
                default: // Evento non gestito? Logga e non fare nulla
                    console.warn(`Tipo evento casuale non gestito: ${eventType}`);
                    return; // Esce senza mostrare popup
            }

            // Aggiorna stats se l'evento ha avuto effetto immediato (loot)
            if (statsChanged) {
                renderStats();
                if (checkGameOver()) return; // Esce se game over dopo loot
            }

            // Mostra il popup dell'evento
            showEventPopup(title, desc, choices, check, cons);
        }


        function handleEventChoice(choiceKey) {
            let outcomeTitle = "Esito", outcomeDesc = "", statsChanged = false, outcomeChoices = [], checkResult = null, consequenceText = "";
            const context = currentEventContext; // Usa contesto salvato

            // Nascosto popup precedente DOPO aver recuperato il contesto
            // hideEventScreen(); // Chiamato qui causava flickering, lo lasciamo alla fine

            if (!context) {
                addMessage("Errore nell'elaborazione dell'evento.", 'warning');
                hideEventScreen(); // Nasconde comunque il popup se c'è errore
                return;
            }

            const baseDifficulty = context.difficulty || 12;
            const effectiveDifficulty = baseDifficulty + (context.difficultyMod || 0);

            switch (context.event) {
                case 'predoni':
                    outcomeTitle = "Scontro con Predoni";
                    let predoniDmg = 0, predoniFoodLoss = 0, predoniWaterLoss = 0;
                    switch (choiceKey) {
                        case 'F': // Fuga
                            checkResult = performSkillCheck('agilita', effectiveDifficulty);
                            if (checkResult.success) { outcomeDesc = getRandomText(esitiFugaPredoniOk); }
                            else { outcomeDesc = getRandomText(esitiFugaPredoniKo); predoniDmg = getRandomInt(1, 3); consequenceText = `Vieni colpito (-${predoniDmg} HP).`; }
                            break;
                        case 'C': // Combatti
                            checkResult = performSkillCheck('potenza', effectiveDifficulty + 1); // Combattere è più difficile
                            if (checkResult.success) { outcomeDesc = getRandomText(esitiLottaPredoniOk); }
                            else { outcomeDesc = getRandomText(esitiLottaPredoniKo); predoniDmg = getRandomInt(isDay ? 2 : 3, isDay ? 4 : 5); predoniFoodLoss = Math.min(player.food, getRandomInt(0, isDay ? 1 : 2)); predoniWaterLoss = Math.min(player.water, getRandomInt(0, isDay ? 1 : 2)); consequenceText = `Subisci danni (-${predoniDmg} HP)`; if (predoniFoodLoss > 0) consequenceText += `, perdi cibo (-${predoniFoodLoss})`; if (predoniWaterLoss > 0) consequenceText += `, perdi acqua (-${predoniWaterLoss})`; consequenceText += "."; }
                            break;
                        case 'P': // Parla
                            checkResult = performSkillCheck('influenza', effectiveDifficulty + 2); // Parlare è molto più difficile
                            if (checkResult.success) { outcomeDesc = getRandomText(esitiParlaPredoniOk); }
                            else { outcomeDesc = getRandomText(esitiParlaPredoniKo); predoniDmg = getRandomInt(isDay ? 1 : 2, isDay ? 3 : 4); predoniFoodLoss = Math.min(player.food, getRandomInt(0, isDay ? 2 : 3)); predoniWaterLoss = Math.min(player.water, getRandomInt(0, isDay ? 2 : 3)); consequenceText = `Ti attaccano (-${predoniDmg} HP)`; if (predoniFoodLoss > 0) consequenceText += `, perdi cibo (-${predoniFoodLoss})`; if (predoniWaterLoss > 0) consequenceText += `, perdi acqua (-${predoniWaterLoss})`; consequenceText += "."; }
                            break;
                    }
                    // Applica danni/perdite predoni
                    if (predoniDmg > 0) player.hp = Math.max(0, player.hp - predoniDmg);
                    if (predoniFoodLoss > 0) player.food -= predoniFoodLoss;
                    if (predoniWaterLoss > 0) player.water -= predoniWaterLoss;
                    if (predoniDmg > 0 || predoniFoodLoss > 0 || predoniWaterLoss > 0) statsChanged = true;
                    break;

                case 'animale':
                case 'animale_notturno':
                    outcomeTitle = context.event === 'animale' ? "Incontro con Animale" : "Incontro Notturno";
                    let animaleDmg = 0;
                     switch (choiceKey) {
                        case 'E': // Evita
                            const statToUse = (player.agilita > player.tracce ? 'agilita' : 'tracce');
                            checkResult = performSkillCheck(statToUse, effectiveDifficulty);
                            if (checkResult.success) { outcomeDesc = getRandomText(esitiEvitaAnimaleOk); }
                            else { outcomeDesc = getRandomText(esitiEvitaAnimaleKo); animaleDmg = getRandomInt(isDay ? 1 : 2, isDay ? 2 : 3); consequenceText = `L'animale ti attacca! (-${animaleDmg} HP).`; }
                            break;
                        case 'S': // Spaventa (Solo giorno)
                            if (context.event === 'animale_notturno') { outcomeDesc = "Non puoi spaventare efficacemente ciò che non vedi bene..."; checkResult={text:"Azione inefficace di notte.", success:false}; break; }
                            checkResult = performSkillCheck('influenza', effectiveDifficulty);
                            if (checkResult.success) { outcomeDesc = getRandomText(esitiSpaventaAnimaleOk); }
                            else { outcomeDesc = getRandomText(esitiSpaventaAnimaleKo); animaleDmg = getRandomInt(1, 3); consequenceText = `La bestia si infuria e attacca! (-${animaleDmg} HP).`; }
                            break;
                        case 'A': // Attacca
                            checkResult = performSkillCheck('potenza', effectiveDifficulty);
                            if (checkResult.success) { outcomeDesc = getRandomText(esitiAttaccoAnimaleOk); }
                            else { outcomeDesc = getRandomText(esitiAttaccoAnimaleKo); animaleDmg = getRandomInt(isDay ? 2 : 3, isDay ? 4 : 5); consequenceText = `Vieni ferito (-${animaleDmg} HP).`; }
                            break;
                         case 'O': // Osserva (Solo notte)
                             if (context.event === 'animale') { outcomeDesc = "Non c'è tempo per osservare!"; checkResult={text:"Azione non disponibile di giorno.", success:false}; break;}
                             checkResult = performSkillCheck('tracce', effectiveDifficulty -1); // Osservare è leggermente più facile
                             if (checkResult.success) { outcomeDesc = "Riesci a capire la natura della creatura e a evitarla senza combattere."; /* Potrebbe dare bonus Adattamento? */ }
                             else { outcomeDesc = "Non riesci a capire cosa sia, e ti attacca alla sprovvista!"; animaleDmg = getRandomInt(2, 4); consequenceText = `Attacco improvviso! (-${animaleDmg} HP).`; }
                             break;
                    }
                     // Applica danni animale
                    if (animaleDmg > 0) { player.hp = Math.max(0, player.hp - animaleDmg); statsChanged = true; }
                    break;

                case 'tracce_strane':
                    outcomeTitle = "Seguendo le Tracce";
                    if (choiceKey === 'I') { outcomeDesc = "Decidi di non rischiare e prosegui."; }
                    else if (choiceKey === 'S') {
                        checkResult = performSkillCheck('tracce', effectiveDifficulty);
                        if (checkResult.success) {
                            const outcomeRoll = Math.random();
                            if (isDay && outcomeRoll < 0.35) { // Loot (giorno)
                                const foundLootType = Math.random() < 0.5 ? 'Cibo' : 'Acqua'; const foundAmount = getRandomInt(1, 3);
                                outcomeDesc = `${getRandomText(esitiSeguiTracceOkLoot)} Trovi ${foundAmount} ${foundLootType}.`;
                                if (foundLootType === 'Cibo') player.food += foundAmount; else player.water += foundAmount; statsChanged = true;
                            } else if (isDay && outcomeRoll < 0.55) { // Lore (giorno)
                                outcomeDesc = `${getRandomText(esitiSeguiTracceOkLore)}\n"${getRandomText(loreFragments)}"`;
                                addMessage("Hai trovato della lore seguendo le tracce.", 'info');
                            } else if (outcomeRoll < 0.80) { // Pericolo (Predoni/Animale Notturno)
                                outcomeDesc = getRandomText(esitiSeguiTracceOkPredoni);
                                // Mostra esito tracce, poi triggera nuovo evento
                                showEventPopup(outcomeTitle, outcomeDesc, [], checkResult, consequenceText);
                                triggerRandomEvent(isDay ? ['predoni'] : ['predoni', 'animale_notturno']);
                                return; // Esce, l'evento successivo gestirà il flusso
                            } else { // Nulla
                                outcomeDesc = getRandomText(esitiSeguiTracceOkNulla);
                            }
                        } else { // Fallimento check Tracce
                            outcomeDesc = getRandomText(esitiSeguiTracceKo);
                            if(Math.random() < (isDay ? 0.3 : 0.5)) { // Penalità per fallimento
                                const dmg = 1; player.hp = Math.max(0, player.hp - dmg);
                                consequenceText = `La disattenzione ti costa (-${dmg} HP).`; statsChanged = true;
                            }
                        }
                    }
                    break;

                case 'villaggio_ostile':
                    outcomeTitle = "Accampamento Guardingo";
                    if (choiceKey === 'A') { outcomeDesc = getRandomText(esitiVillaggioOstileAllontanati); }
                    else if (choiceKey === 'N') {
                        checkResult = performSkillCheck('influenza', effectiveDifficulty);
                        if (checkResult.success) { outcomeDesc = getRandomText(esitiVillaggioOstileNegoziaOk); }
                        else {
                            outcomeDesc = getRandomText(esitiVillaggioOstileNegoziaKo);
                            if(Math.random() < 0.4) { // 40% chance di attacco dopo fallimento
                                consequenceText = "Ti attaccano!";
                                // Mostra esito negoziazione fallita, poi triggera attacco
                                showEventPopup(outcomeTitle, outcomeDesc, [], checkResult, consequenceText);
                                triggerRandomEvent(['predoni']); // Usa evento predoni standard
                                return; // Esce
                            }
                        }
                    }
                    break;

                case 'pericolo_ambientale':
                case 'pericolo_ambientale_notturno':
                    outcomeTitle = "Esito Pericolo";
                    let skill = 'agilita'; // Default
                    if (context.subType === 'presagio_check') skill = 'presagio';
                    // Usa la difficoltà specifica del sottotipo salvata nel contesto
                    let hazardDifficulty = (context.subType === 'agilita_check' ? (isDay ? 12 : 13) : (isDay ? 13 : 14));
                    hazardDifficulty += (context.difficultyMod || 0); // Aggiunge mod generico (notte)
                    checkResult = performSkillCheck(skill, hazardDifficulty);
                    if (checkResult.success) { outcomeDesc = getRandomText(esitiPericoloAmbientaleEvitato); }
                    else {
                        const hazardDmg = context.damage || getRandomInt(1,3); // Usa danno dal contesto o default
                        outcomeDesc = getRandomText(esitiPericoloAmbientaleColpito);
                        player.hp = Math.max(0, player.hp - hazardDmg);
                        consequenceText = `Subisci ${hazardDmg} HP di danno.`;
                        statsChanged = true;
                    }
                    break;

                case 'dilemma_morale':
                    outcomeTitle = "Conseguenze";
                    if (choiceKey === 'N') { outcomeDesc = getRandomText(esitiDilemmaMoraleIgnora); }
                    else if (choiceKey === 'I') {
                        checkResult = performSkillCheck('presagio', effectiveDifficulty); // Prova su Presagio per intuire la situazione
                        if (checkResult.success) { // Intuito corretto -> esito positivo
                            outcomeDesc = getRandomText(esitiDilemmaMoraleIndagaOkPositivo);
                            if (Math.random() < 0.5) { // 50% chance di loot bonus
                                const res = Math.random() < 0.5 ? 'food' : 'water'; const amt = getRandomInt(1, 2);
                                player[res] += amt; consequenceText = `Trovi ${amt} ${res}.`; statsChanged = true;
                            }
                        } else { // Intuito fallito -> esito negativo
                             outcomeDesc = getRandomText(esitiDilemmaMoraleIndagaOkNegativo);
                             if (Math.random() < 0.5) { // 50% chance di danno
                                const dmg = getRandomInt(1, 3); player.hp = Math.max(0, player.hp - dmg);
                                consequenceText = `Vieni ferito (-${dmg} HP).`; statsChanged = true;
                             }
                        }
                    }
                    break;

                case 'orrore_indicibile':
                    outcomeTitle = "Confronto con l'Ignoto";
                    let sanityDmg = 0;
                    switch(choiceKey) {
                        case 'F': // Fuga (Agilità)
                            checkResult = performSkillCheck('agilita', effectiveDifficulty);
                            if (checkResult.success) { outcomeDesc = getRandomText(esitiOrroreIndicibileFugaOk); }
                            else { outcomeDesc = getRandomText(esitiOrroreIndicibileFugaKo); sanityDmg = context.sanityDamage || 1; consequenceText = `Il terrore ti sfianca (-${sanityDmg} HP).`; }
                            break;
                        case 'A': // Affronta (Vigore)
                            checkResult = performSkillCheck('vigore', effectiveDifficulty + 1); // Affrontare è più difficile
                            if (checkResult.success) { outcomeDesc = getRandomText(esitiOrroreIndicibileAffrontaOk); }
                            else { outcomeDesc = getRandomText(esitiOrroreIndicibileAffrontaKo); sanityDmg = (context.sanityDamage || 1) * 2; consequenceText = `La tua mente vacilla (-${sanityDmg} HP).`; }
                            break;
                    }
                     // Applica danni "sanità" (HP)
                    if (sanityDmg > 0) { player.hp = Math.max(0, player.hp - sanityDmg); statsChanged = true; }
                    break;

                case 'rifugio_scelta': // Evento ispezione rifugio (giorno)
                    if (choiceKey === 'L') {
                        outcomeTitle = "Prudenza";
                        outcomeDesc = "Decidi di non rischiare e lasci perdere.";
                    } else if (choiceKey === 'I') {
                        outcomeTitle = "Ispezione Rifugio";
                        checkResult = performSkillCheck('tracce', context.difficulty || 11); // Usa difficoltà dal contesto
                        if (checkResult.success) {
                            const outcomeRoll = Math.random();
                            if (outcomeRoll < 0.4) { // Loot
                                const resType = Math.random() < 0.5 ? 'food' : 'water'; const foundAmount = getRandomInt(1, 2);
                                player[resType] += foundAmount;
                                outcomeDesc = getRandomText(esitiRifugioIspezionaOkLoot); consequenceText = `Trovi ${foundAmount} ${resType}.`; statsChanged = true;
                            } else if (outcomeRoll < 0.7) { // Lore
                                outcomeDesc = getRandomText(esitiRifugioIspezionaOkLore); consequenceText = `"${getRandomText(loreFragments)}"`;
                            } else { // Nulla
                                outcomeDesc = getRandomText(esitiRifugioIspezionaKoNulla); consequenceText = "Non trovi nulla di valore.";
                            }
                        } else { // Fallimento check Tracce
                            const outcomeRoll = Math.random();
                            if (outcomeRoll < 0.5) { // Trappola
                                const dmg = getRandomInt(1, 2); player.hp = Math.max(0, player.hp - dmg);
                                outcomeDesc = getRandomText(esitiRifugioIspezionaKoTrappola); consequenceText = `Vieni ferito! (-${dmg} HP).`; statsChanged = true;
                            } else { // Nulla
                                outcomeDesc = getRandomText(esitiRifugioIspezionaKoNulla); consequenceText = "Non trovi nulla di nascosto.";
                            }
                        }
                    }
                    break; // Fine case 'rifugio_scelta'

                case 'ritrovamento_dubbio':
                    if (choiceKey === 'L') {
                        outcomeTitle = "Prudenza";
                        outcomeDesc = "Il tuo istinto ti dice di diffidare. Prosegui.";
                    } else if (choiceKey === 'P') {
                        outcomeTitle = "Rischio Calcolato";
                        outcomeDesc = "Ti avvicini con cautela...";
                        checkResult = performSkillCheck('presagio', effectiveDifficulty);
                        if (checkResult.success) { // Successo Presagio - Loot!
                            const lootType = Math.random() < 0.5 ? 'food' : 'water'; const amount = getRandomInt(1, 2);
                            player[lootType] += amount;
                            outcomeDesc += `\n${getRandomText(["Sembra tutto a posto. Trovi provviste utili!", "È un colpo di fortuna!", "Il contenuto è genuino."])}`;
                            consequenceText = `Hai trovato ${amount} ${lootType}.`; statsChanged = true;
                            addMessage("Ritrovamento fortunato!", "info");
                        } else { // Fallimento Presagio - Trappola/Pericolo!
                            outcomeDesc += `\n${getRandomText(["Appena tocchi l'oggetto, scatta una trappola!", "Era un'esca!", "Qualcosa non torna..."])}`;
                            const trapType = Math.random();
                            if (trapType < 0.6) { // Danno HP
                                const dmg = getRandomInt(1, 3); player.hp = Math.max(0, player.hp - dmg);
                                consequenceText = `Vieni ferito! (-${dmg} HP).`; statsChanged = true;
                                addMessage("Era una trappola!", "warning", true);
                            } else { // Imboscata Predoni
                                consequenceText = "Sei caduto in un'imboscata!";
                                addMessage("Imboscata!", "warning", true);
                                // Mostra esito fallimento, poi triggera predoni
                                showEventPopup(outcomeTitle, outcomeDesc, [], checkResult, consequenceText);
                                triggerRandomEvent(['predoni']);
                                return; // Esce
                            }
                        }
                    }
                     break; // <--- !! BREAK AGGIUNTO !!

                default:
                    console.warn(`Evento non gestito in handleEventChoice: ${context.event}`);
                    outcomeTitle = "Evento Sconosciuto";
                    outcomeDesc = "L'esito non è chiaro...";
                    break;
            }

            // --- Gestione comune fine evento ---
            hideEventScreen(); // Nasconde il popup delle scelte QUI, prima di mostrare l'esito

            if (statsChanged) {
                renderStats();
                if (checkGameOver()) return; // Esce se il giocatore muore dopo l'evento
            }

            // Mostra popup finale dell'evento (con l'esito)
            // Usa outcomeChoices che di solito è vuoto, a meno che un esito non porti ad altre scelte (raro)
            showEventPopup(outcomeTitle, outcomeDesc, outcomeChoices, checkResult, consequenceText);
        }

        function checkGameOver() {
            if (player.hp <= 0 && gameActive) {
                showEndGameMessage(false);
                return true;
            }
            return false;
        }

        function movePlayer(dx, dy) {
            if (!gameActive || eventScreenActive) return;

            const nextX = player.x + dx;
            const nextY = player.y + dy;

            // Controllo confini mappa
            if (nextX < 0 || nextX >= MAP_WIDTH || nextY < 0 || nextY >= MAP_HEIGHT) {
                addMessage("Non puoi andare in quella direzione.");
                return;
            }

            // Aggiorna posizione giocatore
            player.x = nextX;
            player.y = nextY;

            // Gestione ciclo Giorno/Notte
            if (isDay) {
                dayMovesCounter++;
                if (dayMovesCounter >= DAY_LENGTH_MOVES) {
                    isDay = false;
                    dayMovesCounter = 0; // Resetta contatore
                    addMessage("[FASE] Il sole tramonta. È calata la NOTTE. Cerca un rifugio!", 'info', true);
                    renderMap(); // Aggiorna mappa per possibile cambio stile notturno
                    renderStats(); // Aggiorna UI per indicare Notte
                }
            } else {
                // Azioni per ogni passo notturno? (Al momento la difficoltà è gestita negli eventi)
            }

            const currentTile = map[player.y]?.[player.x];
            if (!currentTile) {
                console.error("ERRORE: Casella non valida a", player.x, player.y);
                addMessage("Errore nel terreno!", "warning");
                return;
            }

            // Gestisce evento sulla casella (che può mostrare un popup)
            // handleTileEvent gestisce anche il passaggio da Notte a Giorno nel rifugio
            const popupWasShownByEvent = handleTileEvent(currentTile);

            // Render mappa/stats solo se NON è stato mostrato un popup dall'evento
            // e se il gioco è ancora attivo (non game over)
            if (!popupWasShownByEvent && gameActive) {
                renderMap();
                renderStats(); // Render stats dopo movimento SE non c'è popup
            }
            // checkGameOver è già chiamato all'interno di handleTileEvent se necessario
        }

        function handleKeyPress(event) {
             // Ignora se tasto tenuto premuto
            if (event.repeat) return;

            if (eventScreenActive && currentEventChoices.length > 0) {
                // Gestione input per scelte evento
                const key = event.key.toUpperCase();
                const choice = currentEventChoices.find(c => c.key === key);
                if (choice) {
                    event.preventDefault(); // Previene azione default (es. scroll pagina)
                    handleEventChoice(key);
                }
                 // Se il tasto non corrisponde a una scelta, non fare nulla
            } else if (gameActive && !eventScreenActive) {
                // Gestione input per movimento
                let dx = 0, dy = 0;
                let validMoveKey = false;
                const lowerCaseKey = event.key.toLowerCase();

                switch (lowerCaseKey) {
                    case "arrowup": case "w": dy = -1; validMoveKey = true; break;
                    case "arrowdown": case "s": dy = 1; validMoveKey = true; break;
                    case "arrowleft": case "a": dx = -1; validMoveKey = true; break;
                    case "arrowright": case "d": dx = 1; validMoveKey = true; break;
                }

                if (validMoveKey) {
                    event.preventDefault(); // Previene scroll pagina con frecce
                    movePlayer(dx, dy);
                }
            }
             // Ignora altri tasti se gioco non attivo o evento senza scelte attivo
        }

        function setupInputListeners() {
            // Rimuove listener precedente per sicurezza (evita duplicati)
            document.removeEventListener('keydown', handleKeyPress);
            // Aggiunge nuovo listener
            document.addEventListener('keydown', handleKeyPress);
        }

        // Avvio del gioco all'onload
        window.onload = () => {
            mapDisplay.textContent = "Caricamento..."; // Messaggio iniziale
            initializeGame(); // Avvia direttamente il gioco
        };

    </script>

</body>
</html>
